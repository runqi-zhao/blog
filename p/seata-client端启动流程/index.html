<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='# Apache Seata Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹æä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚åœ¨ Seata å¼€æºä¹‹å‰ï¼Œå…¶å†…éƒ¨ç‰ˆæœ¬åœ¨é˜¿é‡Œç³»å†…éƒ¨ä¸€ç›´æ‰®æ¼”ç€åº”ç”¨æ¶æ„å±‚æ•°æ®ä¸€è‡´æ€§çš„ä¸­é—´ä»¶è§’è‰²ï¼Œå¸®åŠ©ç»æµä½“å¹³ç¨³çš„åº¦è¿‡å†å¹´çš„åŒ11ï¼Œå¯¹ä¸Šå±‚ä¸šåŠ¡è¿›è¡Œäº†æœ‰åŠ›çš„æŠ€æœ¯æ”¯æ’‘ã€‚ç»è¿‡å¤šå¹´æ²‰æ·€ä¸ç§¯ç´¯ï¼Œå…¶å•†ä¸šåŒ–äº§å“å…ˆååœ¨é˜¿é‡Œäº‘ã€é‡‘èäº‘ä¸Šå”®å–ã€‚2019.1 ä¸ºäº†æ‰“é€ æ›´åŠ å®Œå–„çš„æŠ€æœ¯ç”Ÿæ€å’Œæ™®æƒ æŠ€æœ¯æˆæœï¼ŒSeata æ­£å¼å®£å¸ƒå¯¹å¤–å¼€æºï¼Œæœªæ¥ Seata å°†ä»¥ç¤¾åŒºå…±å»ºçš„å½¢å¼å¸®åŠ©ç”¨æˆ·å¿«é€Ÿè½åœ°åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚ æœ¬æ–‡å°†ä»æºç çš„è§’åº¦åˆ†æä¸€ä¸‹ATæ¨¡å¼ä¸‹Clientç«¯å¯åŠ¨æµç¨‹ã€‚ æ‰€è°“çš„Clientç«¯ï¼Œå³ä¸šåŠ¡åº”ç”¨æ”¾ã€‚åˆ†å¸ƒå¼äº‹åŠ¡åˆ†ä¸ºä¸‰ä¸ªæ¨¡å—ï¼šTCã€TMã€RMã€‚å…¶ä¸­TCä½äºserverç«¯ï¼Œè€ŒTMã€RMé€šè¿‡SDKçš„æ–¹å¼è¿è¡Œåœ¨clientç«¯ã€‚ ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªåˆ†å¸ƒå¼åœºæ™¯çš„Demoï¼Œåˆ†ä¸ºå‡ ä¸ªå¾®æœåŠ¡ï¼Œå…±åŒå®ç°ä¸€ä¸ªè®¢å•ã€æ‰£åº“å­˜ã€æ‰£ä½™é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼š BusinessServiceï¼š ä¸šåŠ¡æœåŠ¡ï¼Œä¸‹å•æœåŠ¡çš„å…¥å£ StorageServiceï¼š åº“å­˜å¾®æœåŠ¡ï¼Œç”¨äºæ‰£å‡å•†å“åº“å­˜ OrderServiceï¼š è®¢å•å¾®æœåŠ¡ï¼Œåˆ›å»ºè®¢å• AccountServiceï¼š è´¦æˆ·å¾®æœåŠ¡ï¼Œæ‰£å‡ç”¨æˆ·è´¦æˆ·çš„ä½™é¢ ä»ä¸Šå›¾ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨ATæ¨¡å¼ä¸‹Seata Clientç«¯ä¸»è¦é€šè¿‡å¦‚ä¸‹ä¸‰ä¸ªæ¨¡å—æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼š GlobalTransactionScannerï¼š GlobalTransactionScannerè´Ÿè´£åˆå§‹TMã€RMæ¨¡å—ï¼Œå¹¶ä¸ºæ·»åŠ åˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£çš„æ–¹æ³•æ·»åŠ æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªå™¨è´Ÿè´£å…¨å±€äº‹åŠ¡çš„å¼€å¯ã€æäº¤æˆ–å›æ»š DatasourceProxyï¼š DatasourceProxyä¸ºDataSourceæ·»åŠ æ‹¦æˆªï¼Œæ‹¦æˆªå™¨ä¼šæ‹¦æˆªæ‰€æœ‰SQLæ‰§è¡Œï¼Œå¹¶ä½œä¸ºRMäº‹åŠ¡å‚ä¸æ–¹çš„è§’è‰²å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œã€‚ Rpc Interceptorï¼š Rpc Interceptorçš„èŒè´£å°±æ˜¯è´Ÿè´£åœ¨å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´ä¼ æ’­äº‹åŠ¡ã€‚ # seata-spring-boot-starter å¼•ç”¨seataåˆ†å¸ƒå¼äº‹åŠ¡SDKæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¾èµ–seata-allæˆ–è€…seata-spring-boot-starterï¼Œæ¨èä½¿ç”¨seata-spring-boot-starterï¼Œå› ä¸ºè¯¥starterå·²ç»è‡ªåŠ¨æ³¨å…¥äº†ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªæ¨¡å—ï¼Œç”¨æˆ·åªè¦æ·»åŠ ç›¸åº”çš„é…ç½®ï¼Œåœ¨ä¸šåŠ¡ä»£ç æ·»åŠ å…¨å±€åˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£å³å¯ã€‚ä¸‹é¢ä»seata-spring-boot-starteré¡¹ç›®ä¸­çš„ä»£ç å…¥æ‰‹ï¼š è¿™é‡Œçš„è¯æä¾›äº†é›†ä¸­é›†ä¸­ä¸åŒå¯åŠ¨client çš„æ–¹å¼ï¼Œè¯¦ç»†å†…å®¹å¯ä»¥çœ‹ä¸€çœ¼æ³¨é‡Šï¼Œä¸‹é¢çš„è¯é€‰æ‹©SteataAutoConfigurationè¿›è¡ŒæŸ¥çœ‹ï¼Œå·²è¯´æ˜å¯¹åº”çš„å¯åŠ¨æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 /** * The type Seata auto configuration * */ @ConditionalOnProperty(prefix = SEATA_PREFIX, name = "enabled", havingValue = "true", matchIfMissing = true) @AutoConfigureAfter({SeataCoreAutoConfiguration.'><title>Seata Clientç«¯å¯åŠ¨æµç¨‹</title>
<link rel=canonical href=https://runqizhao.cn/p/seata-client%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/><link rel=stylesheet href=/scss/style.min.8e60baf4cd3fc55968717a6e39762f4d28ed7ef6007566b6c7970ad0fe907198.css><meta property='og:title' content="Seata Clientç«¯å¯åŠ¨æµç¨‹"><meta property='og:description' content='# Apache Seata Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹æä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚åœ¨ Seata å¼€æºä¹‹å‰ï¼Œå…¶å†…éƒ¨ç‰ˆæœ¬åœ¨é˜¿é‡Œç³»å†…éƒ¨ä¸€ç›´æ‰®æ¼”ç€åº”ç”¨æ¶æ„å±‚æ•°æ®ä¸€è‡´æ€§çš„ä¸­é—´ä»¶è§’è‰²ï¼Œå¸®åŠ©ç»æµä½“å¹³ç¨³çš„åº¦è¿‡å†å¹´çš„åŒ11ï¼Œå¯¹ä¸Šå±‚ä¸šåŠ¡è¿›è¡Œäº†æœ‰åŠ›çš„æŠ€æœ¯æ”¯æ’‘ã€‚ç»è¿‡å¤šå¹´æ²‰æ·€ä¸ç§¯ç´¯ï¼Œå…¶å•†ä¸šåŒ–äº§å“å…ˆååœ¨é˜¿é‡Œäº‘ã€é‡‘èäº‘ä¸Šå”®å–ã€‚2019.1 ä¸ºäº†æ‰“é€ æ›´åŠ å®Œå–„çš„æŠ€æœ¯ç”Ÿæ€å’Œæ™®æƒ æŠ€æœ¯æˆæœï¼ŒSeata æ­£å¼å®£å¸ƒå¯¹å¤–å¼€æºï¼Œæœªæ¥ Seata å°†ä»¥ç¤¾åŒºå…±å»ºçš„å½¢å¼å¸®åŠ©ç”¨æˆ·å¿«é€Ÿè½åœ°åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚ æœ¬æ–‡å°†ä»æºç çš„è§’åº¦åˆ†æä¸€ä¸‹ATæ¨¡å¼ä¸‹Clientç«¯å¯åŠ¨æµç¨‹ã€‚ æ‰€è°“çš„Clientç«¯ï¼Œå³ä¸šåŠ¡åº”ç”¨æ”¾ã€‚åˆ†å¸ƒå¼äº‹åŠ¡åˆ†ä¸ºä¸‰ä¸ªæ¨¡å—ï¼šTCã€TMã€RMã€‚å…¶ä¸­TCä½äºserverç«¯ï¼Œè€ŒTMã€RMé€šè¿‡SDKçš„æ–¹å¼è¿è¡Œåœ¨clientç«¯ã€‚ ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªåˆ†å¸ƒå¼åœºæ™¯çš„Demoï¼Œåˆ†ä¸ºå‡ ä¸ªå¾®æœåŠ¡ï¼Œå…±åŒå®ç°ä¸€ä¸ªè®¢å•ã€æ‰£åº“å­˜ã€æ‰£ä½™é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼š BusinessServiceï¼š ä¸šåŠ¡æœåŠ¡ï¼Œä¸‹å•æœåŠ¡çš„å…¥å£ StorageServiceï¼š åº“å­˜å¾®æœåŠ¡ï¼Œç”¨äºæ‰£å‡å•†å“åº“å­˜ OrderServiceï¼š è®¢å•å¾®æœåŠ¡ï¼Œåˆ›å»ºè®¢å• AccountServiceï¼š è´¦æˆ·å¾®æœåŠ¡ï¼Œæ‰£å‡ç”¨æˆ·è´¦æˆ·çš„ä½™é¢ ä»ä¸Šå›¾ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨ATæ¨¡å¼ä¸‹Seata Clientç«¯ä¸»è¦é€šè¿‡å¦‚ä¸‹ä¸‰ä¸ªæ¨¡å—æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼š GlobalTransactionScannerï¼š GlobalTransactionScannerè´Ÿè´£åˆå§‹TMã€RMæ¨¡å—ï¼Œå¹¶ä¸ºæ·»åŠ åˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£çš„æ–¹æ³•æ·»åŠ æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªå™¨è´Ÿè´£å…¨å±€äº‹åŠ¡çš„å¼€å¯ã€æäº¤æˆ–å›æ»š DatasourceProxyï¼š DatasourceProxyä¸ºDataSourceæ·»åŠ æ‹¦æˆªï¼Œæ‹¦æˆªå™¨ä¼šæ‹¦æˆªæ‰€æœ‰SQLæ‰§è¡Œï¼Œå¹¶ä½œä¸ºRMäº‹åŠ¡å‚ä¸æ–¹çš„è§’è‰²å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œã€‚ Rpc Interceptorï¼š Rpc Interceptorçš„èŒè´£å°±æ˜¯è´Ÿè´£åœ¨å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´ä¼ æ’­äº‹åŠ¡ã€‚ # seata-spring-boot-starter å¼•ç”¨seataåˆ†å¸ƒå¼äº‹åŠ¡SDKæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¾èµ–seata-allæˆ–è€…seata-spring-boot-starterï¼Œæ¨èä½¿ç”¨seata-spring-boot-starterï¼Œå› ä¸ºè¯¥starterå·²ç»è‡ªåŠ¨æ³¨å…¥äº†ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªæ¨¡å—ï¼Œç”¨æˆ·åªè¦æ·»åŠ ç›¸åº”çš„é…ç½®ï¼Œåœ¨ä¸šåŠ¡ä»£ç æ·»åŠ å…¨å±€åˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£å³å¯ã€‚ä¸‹é¢ä»seata-spring-boot-starteré¡¹ç›®ä¸­çš„ä»£ç å…¥æ‰‹ï¼š è¿™é‡Œçš„è¯æä¾›äº†é›†ä¸­é›†ä¸­ä¸åŒå¯åŠ¨client çš„æ–¹å¼ï¼Œè¯¦ç»†å†…å®¹å¯ä»¥çœ‹ä¸€çœ¼æ³¨é‡Šï¼Œä¸‹é¢çš„è¯é€‰æ‹©SteataAutoConfigurationè¿›è¡ŒæŸ¥çœ‹ï¼Œå·²è¯´æ˜å¯¹åº”çš„å¯åŠ¨æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 /** * The type Seata auto configuration * */ @ConditionalOnProperty(prefix = SEATA_PREFIX, name = "enabled", havingValue = "true", matchIfMissing = true) @AutoConfigureAfter({SeataCoreAutoConfiguration.'><meta property='og:url' content='https://runqizhao.cn/p/seata-client%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/'><meta property='og:site_name' content='Runqi Blog'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2024-07-04T22:35:24+08:00'><meta property='article:modified_time' content='2024-07-04T22:35:24+08:00'><meta property='og:image' content='https://seata.apache.org/img/seata_logo.png'><meta name=twitter:title content="Seata Clientç«¯å¯åŠ¨æµç¨‹"><meta name=twitter:description content='# Apache Seata Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹æä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚åœ¨ Seata å¼€æºä¹‹å‰ï¼Œå…¶å†…éƒ¨ç‰ˆæœ¬åœ¨é˜¿é‡Œç³»å†…éƒ¨ä¸€ç›´æ‰®æ¼”ç€åº”ç”¨æ¶æ„å±‚æ•°æ®ä¸€è‡´æ€§çš„ä¸­é—´ä»¶è§’è‰²ï¼Œå¸®åŠ©ç»æµä½“å¹³ç¨³çš„åº¦è¿‡å†å¹´çš„åŒ11ï¼Œå¯¹ä¸Šå±‚ä¸šåŠ¡è¿›è¡Œäº†æœ‰åŠ›çš„æŠ€æœ¯æ”¯æ’‘ã€‚ç»è¿‡å¤šå¹´æ²‰æ·€ä¸ç§¯ç´¯ï¼Œå…¶å•†ä¸šåŒ–äº§å“å…ˆååœ¨é˜¿é‡Œäº‘ã€é‡‘èäº‘ä¸Šå”®å–ã€‚2019.1 ä¸ºäº†æ‰“é€ æ›´åŠ å®Œå–„çš„æŠ€æœ¯ç”Ÿæ€å’Œæ™®æƒ æŠ€æœ¯æˆæœï¼ŒSeata æ­£å¼å®£å¸ƒå¯¹å¤–å¼€æºï¼Œæœªæ¥ Seata å°†ä»¥ç¤¾åŒºå…±å»ºçš„å½¢å¼å¸®åŠ©ç”¨æˆ·å¿«é€Ÿè½åœ°åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚ æœ¬æ–‡å°†ä»æºç çš„è§’åº¦åˆ†æä¸€ä¸‹ATæ¨¡å¼ä¸‹Clientç«¯å¯åŠ¨æµç¨‹ã€‚ æ‰€è°“çš„Clientç«¯ï¼Œå³ä¸šåŠ¡åº”ç”¨æ”¾ã€‚åˆ†å¸ƒå¼äº‹åŠ¡åˆ†ä¸ºä¸‰ä¸ªæ¨¡å—ï¼šTCã€TMã€RMã€‚å…¶ä¸­TCä½äºserverç«¯ï¼Œè€ŒTMã€RMé€šè¿‡SDKçš„æ–¹å¼è¿è¡Œåœ¨clientç«¯ã€‚ ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªåˆ†å¸ƒå¼åœºæ™¯çš„Demoï¼Œåˆ†ä¸ºå‡ ä¸ªå¾®æœåŠ¡ï¼Œå…±åŒå®ç°ä¸€ä¸ªè®¢å•ã€æ‰£åº“å­˜ã€æ‰£ä½™é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼š BusinessServiceï¼š ä¸šåŠ¡æœåŠ¡ï¼Œä¸‹å•æœåŠ¡çš„å…¥å£ StorageServiceï¼š åº“å­˜å¾®æœåŠ¡ï¼Œç”¨äºæ‰£å‡å•†å“åº“å­˜ OrderServiceï¼š è®¢å•å¾®æœåŠ¡ï¼Œåˆ›å»ºè®¢å• AccountServiceï¼š è´¦æˆ·å¾®æœåŠ¡ï¼Œæ‰£å‡ç”¨æˆ·è´¦æˆ·çš„ä½™é¢ ä»ä¸Šå›¾ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨ATæ¨¡å¼ä¸‹Seata Clientç«¯ä¸»è¦é€šè¿‡å¦‚ä¸‹ä¸‰ä¸ªæ¨¡å—æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼š GlobalTransactionScannerï¼š GlobalTransactionScannerè´Ÿè´£åˆå§‹TMã€RMæ¨¡å—ï¼Œå¹¶ä¸ºæ·»åŠ åˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£çš„æ–¹æ³•æ·»åŠ æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªå™¨è´Ÿè´£å…¨å±€äº‹åŠ¡çš„å¼€å¯ã€æäº¤æˆ–å›æ»š DatasourceProxyï¼š DatasourceProxyä¸ºDataSourceæ·»åŠ æ‹¦æˆªï¼Œæ‹¦æˆªå™¨ä¼šæ‹¦æˆªæ‰€æœ‰SQLæ‰§è¡Œï¼Œå¹¶ä½œä¸ºRMäº‹åŠ¡å‚ä¸æ–¹çš„è§’è‰²å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œã€‚ Rpc Interceptorï¼š Rpc Interceptorçš„èŒè´£å°±æ˜¯è´Ÿè´£åœ¨å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´ä¼ æ’­äº‹åŠ¡ã€‚ # seata-spring-boot-starter å¼•ç”¨seataåˆ†å¸ƒå¼äº‹åŠ¡SDKæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¾èµ–seata-allæˆ–è€…seata-spring-boot-starterï¼Œæ¨èä½¿ç”¨seata-spring-boot-starterï¼Œå› ä¸ºè¯¥starterå·²ç»è‡ªåŠ¨æ³¨å…¥äº†ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªæ¨¡å—ï¼Œç”¨æˆ·åªè¦æ·»åŠ ç›¸åº”çš„é…ç½®ï¼Œåœ¨ä¸šåŠ¡ä»£ç æ·»åŠ å…¨å±€åˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£å³å¯ã€‚ä¸‹é¢ä»seata-spring-boot-starteré¡¹ç›®ä¸­çš„ä»£ç å…¥æ‰‹ï¼š è¿™é‡Œçš„è¯æä¾›äº†é›†ä¸­é›†ä¸­ä¸åŒå¯åŠ¨client çš„æ–¹å¼ï¼Œè¯¦ç»†å†…å®¹å¯ä»¥çœ‹ä¸€çœ¼æ³¨é‡Šï¼Œä¸‹é¢çš„è¯é€‰æ‹©SteataAutoConfigurationè¿›è¡ŒæŸ¥çœ‹ï¼Œå·²è¯´æ˜å¯¹åº”çš„å¯åŠ¨æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 /** * The type Seata auto configuration * */ @ConditionalOnProperty(prefix = SEATA_PREFIX, name = "enabled", havingValue = "true", matchIfMissing = true) @AutoConfigureAfter({SeataCoreAutoConfiguration.'><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://seata.apache.org/img/seata_logo.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu9b4ee4aab7d2c9a136b427e2430a0345_27821_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>Runqi Blog</a></h1><h2 class=site-description>Stay foolish stay hungry</h2></div></header><ol class=menu-social><li><a href=https://github.com/runqi-zhao target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#apache-seata>Apache Seata</a></li></ol></li><li><a href=#seata-spring-boot-starter>seata-spring-boot-starter</a><ol><li><a href=#globaltransactionscanner>GlobalTransactionScanner</a><ol><li><a href=#åˆå§‹åŒ–tmå’Œbm>åˆå§‹åŒ–TMå’ŒBM</a></li></ol></li><li><a href=#æ•°æ®æºä»£ç†>æ•°æ®æºä»£ç†</a><ol><li><a href=#seatadatasourcebeanpostprocessor>SeataDataSourceBeanPostProcessor</a></li><li><a href=#seataautodatasourceproxycreator>SeataAutoDataSourceProxyCreator</a></li></ol></li><li><a href=#web-mvcä»£ç†>Web MVCä»£ç†</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/seata-client%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/><img src=https://seata.apache.org/img/seata_logo.png loading=lazy alt="Featured image of post Seata Clientç«¯å¯åŠ¨æµç¨‹"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/seata-client%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/>Seata Clientç«¯å¯åŠ¨æµç¨‹</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jul 04, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>13 minute read</time></div></footer></div></header><section class=article-content><h3 id=apache-seata><a href=#apache-seata>#</a>
Apache Seata</h3><p>Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹æä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚åœ¨ Seata å¼€æºä¹‹å‰ï¼Œå…¶å†…éƒ¨ç‰ˆæœ¬åœ¨é˜¿é‡Œç³»å†…éƒ¨ä¸€ç›´æ‰®æ¼”ç€åº”ç”¨æ¶æ„å±‚æ•°æ®ä¸€è‡´æ€§çš„ä¸­é—´ä»¶è§’è‰²ï¼Œå¸®åŠ©ç»æµä½“å¹³ç¨³çš„åº¦è¿‡å†å¹´çš„åŒ11ï¼Œå¯¹ä¸Šå±‚ä¸šåŠ¡è¿›è¡Œäº†æœ‰åŠ›çš„æŠ€æœ¯æ”¯æ’‘ã€‚ç»è¿‡å¤šå¹´æ²‰æ·€ä¸ç§¯ç´¯ï¼Œå…¶å•†ä¸šåŒ–äº§å“å…ˆååœ¨é˜¿é‡Œäº‘ã€é‡‘èäº‘ä¸Šå”®å–ã€‚2019.1 ä¸ºäº†æ‰“é€ æ›´åŠ å®Œå–„çš„æŠ€æœ¯ç”Ÿæ€å’Œæ™®æƒ æŠ€æœ¯æˆæœï¼ŒSeata æ­£å¼å®£å¸ƒå¯¹å¤–å¼€æºï¼Œæœªæ¥ Seata å°†ä»¥ç¤¾åŒºå…±å»ºçš„å½¢å¼å¸®åŠ©ç”¨æˆ·å¿«é€Ÿè½åœ°åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚</p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/68747470733a2f2f696d672d313331323037323436392e636f732e61702d6e616e6a696e672e6d7971636c6f75642e636f6d2f5442317244706b4a41766f4b31526a535a5066585858504b4658612d3739342d3437382e706e67 loading=lazy alt=img></p><p>æœ¬æ–‡å°†ä»æºç çš„è§’åº¦åˆ†æä¸€ä¸‹ATæ¨¡å¼ä¸‹Clientç«¯å¯åŠ¨æµç¨‹ã€‚</p><p>æ‰€è°“çš„Clientç«¯ï¼Œå³ä¸šåŠ¡åº”ç”¨æ”¾ã€‚åˆ†å¸ƒå¼äº‹åŠ¡åˆ†ä¸ºä¸‰ä¸ªæ¨¡å—ï¼šTCã€TMã€RMã€‚å…¶ä¸­TCä½äºserverç«¯ï¼Œè€ŒTMã€RMé€šè¿‡SDKçš„æ–¹å¼è¿è¡Œåœ¨clientç«¯ã€‚</p><p>ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªåˆ†å¸ƒå¼åœºæ™¯çš„Demoï¼Œåˆ†ä¸ºå‡ ä¸ªå¾®æœåŠ¡ï¼Œå…±åŒå®ç°ä¸€ä¸ªè®¢å•ã€æ‰£åº“å­˜ã€æ‰£ä½™é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼š</p><ul><li><strong>BusinessServiceï¼š</strong> ä¸šåŠ¡æœåŠ¡ï¼Œä¸‹å•æœåŠ¡çš„å…¥å£</li><li><strong>StorageServiceï¼š</strong> åº“å­˜å¾®æœåŠ¡ï¼Œç”¨äºæ‰£å‡å•†å“åº“å­˜</li><li><strong>OrderServiceï¼š</strong> è®¢å•å¾®æœåŠ¡ï¼Œåˆ›å»ºè®¢å•</li><li><strong>AccountServiceï¼š</strong> è´¦æˆ·å¾®æœåŠ¡ï¼Œæ‰£å‡ç”¨æˆ·è´¦æˆ·çš„ä½™é¢</li></ul><p><img src=https://camo.githubusercontent.com/07bb523669b0832060fb69d76dc43b78230290e16971915ee35dfd5c9fb8038f/68747470733a2f2f696d672d313331323037323436392e636f732e61702d6e616e6a696e672e6d7971636c6f75642e636f6d2f32303230303832303138343135363735382e6a7067 loading=lazy alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><p>ä»ä¸Šå›¾ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨ATæ¨¡å¼ä¸‹Seata Clientç«¯ä¸»è¦é€šè¿‡å¦‚ä¸‹ä¸‰ä¸ªæ¨¡å—æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼š</p><ul><li><strong>GlobalTransactionScannerï¼š</strong> GlobalTransactionScannerè´Ÿè´£åˆå§‹TMã€RMæ¨¡å—ï¼Œå¹¶ä¸ºæ·»åŠ åˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£çš„æ–¹æ³•æ·»åŠ æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªå™¨è´Ÿè´£å…¨å±€äº‹åŠ¡çš„å¼€å¯ã€æäº¤æˆ–å›æ»š</li><li><strong>DatasourceProxyï¼š</strong> DatasourceProxyä¸ºDataSourceæ·»åŠ æ‹¦æˆªï¼Œæ‹¦æˆªå™¨ä¼šæ‹¦æˆªæ‰€æœ‰SQLæ‰§è¡Œï¼Œå¹¶ä½œä¸ºRMäº‹åŠ¡å‚ä¸æ–¹çš„è§’è‰²å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œã€‚</li><li><strong>Rpc Interceptorï¼š</strong> Rpc Interceptorçš„èŒè´£å°±æ˜¯è´Ÿè´£åœ¨å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´ä¼ æ’­äº‹åŠ¡ã€‚</li></ul><h2 id=seata-spring-boot-starter><a href=#seata-spring-boot-starter>#</a>
seata-spring-boot-starter</h2><p>å¼•ç”¨seataåˆ†å¸ƒå¼äº‹åŠ¡SDKæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¾èµ–seata-allæˆ–è€…seata-spring-boot-starterï¼Œæ¨èä½¿ç”¨seata-spring-boot-starterï¼Œå› ä¸ºè¯¥starterå·²ç»è‡ªåŠ¨æ³¨å…¥äº†ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªæ¨¡å—ï¼Œç”¨æˆ·åªè¦æ·»åŠ ç›¸åº”çš„é…ç½®ï¼Œåœ¨ä¸šåŠ¡ä»£ç æ·»åŠ å…¨å±€åˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£å³å¯ã€‚ä¸‹é¢ä»seata-spring-boot-starteré¡¹ç›®ä¸­çš„ä»£ç å…¥æ‰‹ï¼š</p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/1720331088488.jpg loading=lazy alt=1720331088488></p><p>è¿™é‡Œçš„è¯æä¾›äº†é›†ä¸­é›†ä¸­ä¸åŒå¯åŠ¨client çš„æ–¹å¼ï¼Œè¯¦ç»†å†…å®¹å¯ä»¥çœ‹ä¸€çœ¼æ³¨é‡Šï¼Œä¸‹é¢çš„è¯é€‰æ‹©<code>SteataAutoConfiguration</code>è¿›è¡ŒæŸ¥çœ‹ï¼Œå·²è¯´æ˜å¯¹åº”çš„å¯åŠ¨æµç¨‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * The type Seata auto configuration
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ConditionalOnProperty</span><span class=p>(</span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SEATA_PREFIX</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;enabled&#34;</span><span class=p>,</span><span class=w> </span><span class=n>havingValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>,</span><span class=w> </span><span class=n>matchIfMissing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AutoConfigureAfter</span><span class=p>({</span><span class=n>SeataCoreAutoConfiguration</span><span class=p>.</span><span class=na>class</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeataAutoConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Logger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>LOGGER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>SeataAutoConfiguration</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=n>BEAN_NAME_FAILURE_HANDLER</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ConditionalOnMissingBean</span><span class=p>(</span><span class=n>FailureHandler</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>FailureHandler</span><span class=w> </span><span class=nf>failureHandler</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultFailureHandlerImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// GlobalTransactionScannerè´Ÿè´£æ·»åŠ GlobalTransactionScanneræ³¨è§£çš„æ–¹æ³•æ·»åŠ æ‹¦æˆªå™¨ï¼Œå¹¶ä¸”è´Ÿè´£åˆå§‹åŒ–RMã€TM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DependsOn</span><span class=p>({</span><span class=n>BEAN_NAME_SPRING_APPLICATION_CONTEXT_PROVIDER</span><span class=p>,</span><span class=w> </span><span class=n>BEAN_NAME_FAILURE_HANDLER</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ConditionalOnMissingBean</span><span class=p>(</span><span class=n>GlobalTransactionScanner</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>GlobalTransactionScanner</span><span class=w> </span><span class=nf>globalTransactionScanner</span><span class=p>(</span><span class=n>SeataProperties</span><span class=w> </span><span class=n>seataProperties</span><span class=p>,</span><span class=w> </span><span class=n>FailureHandler</span><span class=w> </span><span class=n>failureHandler</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ConfigurableListableBeanFactory</span><span class=w> </span><span class=n>beanFactory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Autowired</span><span class=p>(</span><span class=n>required</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ScannerChecker</span><span class=o>&gt;</span><span class=w> </span><span class=n>scannerCheckers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isInfoEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Automatically configure Seata&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ä¸‹é¢çš„è¯ä½¿ç”¨ä¸€äº›äº†é…ç½®æ–‡ä»¶çš„å±æ€§ï¼Œæ¯”å¦‚applicationIdã€txServiceGroupã€scanPackagesã€excludesForScanningã€accessKeyã€secretKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ç„¶åç”¨æˆ·å¯ä»¥è‡ªå·±è®¾ç½®å¯¹åº”çš„å±æ€§ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// set bean factory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GlobalTransactionScanner</span><span class=p>.</span><span class=na>setBeanFactory</span><span class=p>(</span><span class=n>beanFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// add checkers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// &#39;/META-INF/services/org.apache.seata.spring.annotation.ScannerChecker&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GlobalTransactionScanner</span><span class=p>.</span><span class=na>addScannerCheckers</span><span class=p>(</span><span class=n>EnhancedServiceLoader</span><span class=p>.</span><span class=na>loadAll</span><span class=p>(</span><span class=n>ScannerChecker</span><span class=p>.</span><span class=na>class</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// spring beans</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GlobalTransactionScanner</span><span class=p>.</span><span class=na>addScannerCheckers</span><span class=p>(</span><span class=n>scannerCheckers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// add scannable packages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GlobalTransactionScanner</span><span class=p>.</span><span class=na>addScannablePackages</span><span class=p>(</span><span class=n>seataProperties</span><span class=p>.</span><span class=na>getScanPackages</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// add excludeBeanNames</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GlobalTransactionScanner</span><span class=p>.</span><span class=na>addScannerExcludeBeanNames</span><span class=p>(</span><span class=n>seataProperties</span><span class=p>.</span><span class=na>getExcludesForScanning</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//set accessKey and secretKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GlobalTransactionScanner</span><span class=p>.</span><span class=na>setAccessKey</span><span class=p>(</span><span class=n>seataProperties</span><span class=p>.</span><span class=na>getAccessKey</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GlobalTransactionScanner</span><span class=p>.</span><span class=na>setSecretKey</span><span class=p>(</span><span class=n>seataProperties</span><span class=p>.</span><span class=na>getSecretKey</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// create global transaction scanner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GlobalTransactionScanner</span><span class=p>(</span><span class=n>seataProperties</span><span class=p>.</span><span class=na>getApplicationId</span><span class=p>(),</span><span class=w> </span><span class=n>seataProperties</span><span class=p>.</span><span class=na>getTxServiceGroup</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>seataProperties</span><span class=p>.</span><span class=na>isExposeProxy</span><span class=p>(),</span><span class=w> </span><span class=n>failureHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿›è¡Œæ‹¦æˆªçš„æ—¶å€™ï¼Œä½¿ç”¨åˆ°äº†ä¸€ä¸ªç±»ï¼Œä¸º<code>GlobalTransactionScanner</code>ï¼Œä¸‹é¢è¯¦ç»†çš„æŸ¥çœ‹è¿™ä¸ªç±»ã€‚</p><h3 id=globaltransactionscanner><a href=#globaltransactionscanner>#</a>
GlobalTransactionScanner</h3><p>GlobalTransactionScannerç»§æ‰¿äºAbstractAutoProxyCreatorï¼ŒAbstractAutoProxyCreatorå¯ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å®ç°å¯¹åº”çš„åŠ¨æ€ä»£ç†ï¼Œä¸‹é¢é‡ç‚¹æŸ¥çœ‹å­—æ®µå’Œæ‹¦æˆªä»£ç†çš„æ ¸å¿ƒæ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>GlobalTransactionScanner</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractAutoProxyCreator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>implements</span><span class=w> </span><span class=n>CachedConfigurationChangeListener</span><span class=p>,</span><span class=w> </span><span class=n>InitializingBean</span><span class=p>,</span><span class=w> </span><span class=n>ApplicationContextAware</span><span class=p>,</span><span class=w> </span><span class=n>DisposableBean</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// PROXYED_SETå­˜å‚¨å·²ç»ä»£ç†è¿‡çš„å®ä¾‹ï¼Œé˜²æ­¢é‡å¤å¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>PROXYED_SET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>EXCLUDE_BEAN_NAME_SET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>ScannerChecker</span><span class=o>&gt;</span><span class=w> </span><span class=n>SCANNER_CHECKER_SET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedHashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ConfigurableListableBeanFactory</span><span class=w> </span><span class=n>beanFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// interceptorå­—æ®µæ˜¯å¯¹åº”ä¸€ä¸ªä»£ç†å¯¹è±¡çš„æ‹¦æˆªå™¨ï¼Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œæœ‰æ•ˆæœŸæ˜¯ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=n>interceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// applicationIdæ˜¯ä¸€ä¸ªæœåŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œå¯¹åº”springcloudé¡¹ç›®ä¸­çš„spring.application.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>applicationId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// äº‹åŠ¡çš„åˆ†ç»„æ ‡è¯†ï¼Œå‚è€ƒæ–‡ç« wikiï¼šhttps://seata.apache.org/zh-cn/docs/user/txgroup/transaction-group/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>txServiceGroup</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * The following will be scanned, and added corresponding interceptor:
</span></span></span><span class=line><span class=cl><span class=cm>     * å°†æ‰«æä»¥ä¸‹å†…å®¹ï¼Œå¹¶æ·»åŠ ç›¸åº”çš„æ‹¦æˆªå™¨ï¼š
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *  é¦–å…ˆæ˜¯TMæ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¸‹å°è¯•
</span></span></span><span class=line><span class=cl><span class=cm>     * TM:
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @see org.apache.seata.spring.annotation.GlobalTransactional // TM annotation
</span></span></span><span class=line><span class=cl><span class=cm>     * Corresponding interceptor:org.apache.seata.integration.tx.api.interceptor.handler.GlobalTransactionalInterceptorHandler
</span></span></span><span class=line><span class=cl><span class=cm>     * @see GlobalTransactionalInterceptorHandler#handleGlobalTransaction(InvocationWrapper, AspectTransactional) // TM handler
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * GlobalLock:
</span></span></span><span class=line><span class=cl><span class=cm>     * @see org.apache.seata.spring.annotation.GlobalLock // GlobalLock annotation
</span></span></span><span class=line><span class=cl><span class=cm>     * Corresponding interceptor:
</span></span></span><span class=line><span class=cl><span class=cm>     * @see GlobalTransactionalInterceptorHandler#handleGlobalLock(InvocationWrapper, GlobalLock)  // GlobalLock handler
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * TCC mode:
</span></span></span><span class=line><span class=cl><span class=cm>     * @see org.apache.seata.rm.tcc.api.LocalTCC // TCC annotation on interface
</span></span></span><span class=line><span class=cl><span class=cm>     * @see org.apache.seata.rm.tcc.api.TwoPhaseBusinessAction // TCC annotation on try method
</span></span></span><span class=line><span class=cl><span class=cm>     * @see org.apache.seata.integration.tx.api.remoting.RemotingParser // Remote TCC service parser
</span></span></span><span class=line><span class=cl><span class=cm>     * Corresponding interceptor:
</span></span></span><span class=line><span class=cl><span class=cm>     * @see org.apache.seata.rm.tcc.interceptor.TccActionInterceptorHandler // the interceptor of TCC mode
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>wrapIfNecessary</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>cacheKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// do checkers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>doCheckers</span><span class=p>(</span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//è¿™éƒ¨åˆ†åŠ ä¸Šsynchronizedï¼Œå…·ä½“åŠŸèƒ½å¯èƒ½è¿˜éœ€è¦è¿›è¡ŒæŸ¥çœ‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// TODOï¼šè¿™é‡Œçš„synchronizedæ˜¯ä¸ºäº†ä¿è¯PROXYED_SETå’ŒNEED_ENHANCE_BEAN_NAME_SETçš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯è¿™é‡Œçš„é€»è¾‘è¿˜æ˜¯éœ€è¦è¿›ä¸€æ­¥æŸ¥çœ‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>PROXYED_SET</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>PROXYED_SET</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>beanName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>NEED_ENHANCE_BEAN_NAME_SET</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>beanName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ¯æ¬¡å¤„ç†ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡æ—¶å…ˆæŠŠinterceptorç½®ä¸ºnullï¼Œæ‰€ä»¥interceptorçš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡ï¼Œç”±äºæ˜¯åœ¨å¦å¤–ä¸€ä¸ªæ–¹æ³•getAdvicesAndAdvisorsForBean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ä¸­ä½¿ç”¨interceptorï¼Œæ‰€ä»¥è¯¥interceptorè¦å®šä¹‰ä¸ºä¸€ä¸ªç±»å˜é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>interceptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//åˆ¤å®šå¯¹åº”çš„åäº”ç±»å‹ï¼Œä¸»è¦åˆ¤å®šä¾æ®æ˜¯æ–¹æ³•ä¸Šæ˜¯å¦æœ‰å¯¹åº”çš„æ³¨è§£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ProxyInvocationHandler</span><span class=w> </span><span class=n>proxyInvocationHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DefaultInterfaceParser</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>parserInterfaceToProxy</span><span class=p>(</span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>proxyInvocationHandler</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// åˆ›å»ºå¯¹åº”çš„äº‹åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>interceptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AdapterSpringSeataInterceptor</span><span class=p>(</span><span class=n>proxyInvocationHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Bean [{}] with name [{}] would use interceptor [{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>bean</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>(),</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>interceptor</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>AopUtils</span><span class=p>.</span><span class=na>isAopProxy</span><span class=p>(</span><span class=n>bean</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å¦‚æœbeanæœ¬èº«ä¸æ˜¯Proxyå¯¹è±¡ï¼Œåˆ™ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„wrapIfNecessaryç”Ÿæˆä»£ç†å¯¹è±¡å³å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// åœ¨çˆ¶ç±»ä¸­ä¼šè°ƒç”¨getAdvicesAndAdvisorsForBeanè·å–åˆ°ä¸Šé¢å®šä¹‰çš„interceptor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>bean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>wrapIfNecessary</span><span class=p>(</span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>cacheKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å¦‚æœè¯¥beanå·²ç»æ˜¯ä»£ç†å¯¹è±¡äº†ï¼Œåˆ™ç›´æ¥åœ¨ä»£ç†å¯¹è±¡çš„æ‹¦æˆªè°ƒç”¨é“¾AdvisedSupport</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ä¸Šç›´æ¥æ·»åŠ æ–°çš„interceptorå³å¯ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>AdvisedSupport</span><span class=w> </span><span class=n>advised</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SpringProxyUtils</span><span class=p>.</span><span class=na>getAdvisedSupport</span><span class=p>(</span><span class=n>bean</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Advisor</span><span class=o>[]</span><span class=w> </span><span class=n>advisor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buildAdvisors</span><span class=p>(</span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>getAdvicesAndAdvisorsForBean</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>pos</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Advisor</span><span class=w> </span><span class=n>avr</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>advisor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Find the position based on the advisor&#39;s order, and add to advisors by pos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findAddSeataAdvisorPosition</span><span class=p>(</span><span class=n>advised</span><span class=p>,</span><span class=w> </span><span class=n>avr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>advised</span><span class=p>.</span><span class=na>addAdvisor</span><span class=p>(</span><span class=n>pos</span><span class=p>,</span><span class=w> </span><span class=n>avr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ ‡è¯†è¯¥beanNameå·²ç»å¤„ç†è¿‡äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>PROXYED_SET</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>exx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>exx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å½“è°ƒç”¨è¢«<code>@GlobalTransactional</code>æˆ–<code>@GlobalLock</code>æ³¨è§£ä¿®é¥°çš„æ–¹æ³•æ—¶ï¼Œä¼šè°ƒåˆ°ä»£ç†å¯¹è±¡ï¼Œè€Œå¢å¼ºé€»è¾‘åœ¨<code>GlobalTransactionalInterceptor</code>ç±»çš„invokeæ–¹æ³•é‡Œã€‚è€Œå…·ä½“æ˜¯å¦‚ä½•å¢å¼ºçš„ä»¥åŠäº‹åŠ¡æ—¶å¦‚ä½•æ‰§è¡Œçš„æ”¾åœ¨å¦ä¸€ç¯‡ä¸“é—¨è®²è§£ã€‚</p><h4 id=åˆå§‹åŒ–tmå’Œbm><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96tm%e5%92%8cbm>#</a>
åˆå§‹åŒ–TMå’ŒBM</h4><p>GlobalTransactionScannerè¿˜å®ç°äº†<code>InitializingBean</code>æ¥å£ï¼Œæ‰€ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µè¿˜ä¼šè°ƒç”¨<code>afterPropertiesSet</code>æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterPropertiesSet</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>disableGlobalTransaction</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isInfoEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Global transaction is disabled.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ConfigurationFactory</span><span class=p>.</span><span class=na>getInstance</span><span class=p>().</span><span class=na>addConfigListener</span><span class=p>(</span><span class=n>ConfigurationKeys</span><span class=p>.</span><span class=na>DISABLE_GLOBAL_TRANSACTION</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>CachedConfigurationChangeListener</span><span class=p>)</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœseataå®¢æˆ·ç«¯è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>initialized</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>initClient</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>findBusinessBeanNamesNeededEnhancement</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œä¼šå¯¹TMå’ŒRMè¿›è¡Œåˆå§‹åŒ–ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªnettyå®¢æˆ·ç«¯ï¼Œç„¶åå‘tcæ³¨å†Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initClient</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isInfoEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Initializing Global Transaction Clients ... &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEFAULT_TX_GROUP_OLD</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>txServiceGroup</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;the default value of seata.tx-service-group: {} has already changed to {} since Seata 1.5, &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;please change your default configuration as soon as possible &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;and we don&#39;t recommend you to use default tx-service-group&#39;s value provided by seata&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>DEFAULT_TX_GROUP_OLD</span><span class=p>,</span><span class=w> </span><span class=n>DEFAULT_TX_GROUP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isNullOrEmpty</span><span class=p>(</span><span class=n>applicationId</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isNullOrEmpty</span><span class=p>(</span><span class=n>txServiceGroup</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;applicationId: %s, txServiceGroup: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>applicationId</span><span class=p>,</span><span class=w> </span><span class=n>txServiceGroup</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//init TM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆå§‹åŒ– TMï¼Œæœ¬è´¨å°±æ˜¯åˆ›å»ºä¸€ä¸ªtmçš„nettyå®¢æˆ·ç«¯ï¼Œç„¶åå‘tcæ³¨å†Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TMClient</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>applicationId</span><span class=p>,</span><span class=w> </span><span class=n>txServiceGroup</span><span class=p>,</span><span class=w> </span><span class=n>accessKey</span><span class=p>,</span><span class=w> </span><span class=n>secretKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isInfoEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Transaction Manager Client is initialized. applicationId[{}] txServiceGroup[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>applicationId</span><span class=p>,</span><span class=w> </span><span class=n>txServiceGroup</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//init RM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆå§‹åŒ– RMï¼Œæœ¬è´¨å°±æ˜¯åˆ›å»ºä¸€ä¸ªrmçš„nettyå®¢æˆ·ç«¯ï¼Œç„¶åå‘tcæ³¨å†Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//TODO:ä¸å‡ºæ„å¤–æ”¹é€ çš„å°±æ˜¯è¿™é‡Œï¼Œæ”¹é€ çš„ç›®çš„æ˜¯ä¸ºäº†æ”¯æŒå¤šClientçš„æ¨¡å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RMClient</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>applicationId</span><span class=p>,</span><span class=w> </span><span class=n>txServiceGroup</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isInfoEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Resource Manager is initialized. applicationId[{}] txServiceGroup[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>applicationId</span><span class=p>,</span><span class=w> </span><span class=n>txServiceGroup</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isInfoEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Global Transaction Clients are initialized. &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registerSpringShutdownHook</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åˆå§‹åŒ– TM</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>applicationId</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>transactionServiceGroup</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>accessKey</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>secretKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–TMå®¢æˆ·ç«¯å®ä¾‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TmNettyRemotingClient</span><span class=w> </span><span class=n>tmNettyRemotingClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TmNettyRemotingClient</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=n>applicationId</span><span class=p>,</span><span class=w> </span><span class=n>transactionServiceGroup</span><span class=p>,</span><span class=w> </span><span class=n>accessKey</span><span class=p>,</span><span class=w> </span><span class=n>secretKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆå§‹åŒ–TMçš„nettyå®¢æˆ·ç«¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tmNettyRemotingClient</span><span class=p>.</span><span class=na>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨è·å–TMå®¢æˆ·ç«¯å®ä¾‹æ—¶ï¼Œä¼šåˆ›å»ºnettyå®¢æˆ·ç«¯ï¼Œä½†è¿˜æœªå¯åŠ¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ³¨å†Œç›¸å…³å¤„ç†å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registerProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>initialized</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ³¨å†Œä¸¤ä¸ªå¤„ç†å™¨ï¼Œç”¨æ¥å¤„ç†TCè¿”å›ç»™TMçš„å“åº”</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>registerProcessor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1.registry TC response processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ³¨å†ŒSeata-Serverè¿”å›çš„Responseçš„å¤„ç†Processorï¼Œç”¨äºClientä¸»åŠ¨å‘èµ·Requestï¼Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Seata-Serverè¿”å›çš„Response</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClientOnResponseProcessor</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>ClientOnResponseProcessor</span><span class=p>(</span><span class=n>mergeMsgMap</span><span class=p>,</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>getFutures</span><span class=p>(),</span><span class=w> </span><span class=n>getTransactionMessageHandler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_SEATA_MERGE_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_GLOBAL_BEGIN_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_GLOBAL_COMMIT_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_GLOBAL_REPORT_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_GLOBAL_ROLLBACK_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_GLOBAL_STATUS_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_REG_CLT_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_BATCH_RESULT_MSG</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2.registry heartbeat message processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ClientOnResponseProcessorè´Ÿè´£æŠŠClientå‘é€çš„Requestå’ŒSeata-Server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿”å›çš„Responseå¯¹åº”èµ·æ¥ï¼Œä»è€Œå®ç°Rpc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClientHeartbeatProcessor</span><span class=w> </span><span class=n>clientHeartbeatProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ClientHeartbeatProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_HEARTBEAT_MSG</span><span class=p>,</span><span class=w> </span><span class=n>clientHeartbeatProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨çˆ¶ç±»AbstractNettyRemotingClientä¸­å¯åŠ¨TMçš„nettyå®¢æˆ·ç«¯ï¼Œè¿™é‡Œçš„è¯æš‚æ—¶æŒ‰ä¸‹ä¸è¡¨ã€‚ä¸‹é¢ç®€å•åˆ†æRMçš„initæ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å®šæ—¶é‡æ–°å‘é€ RegisterTMRequestï¼ˆRM å®¢æˆ·ç«¯ä¼šå‘é€ RegisterRMRequestï¼‰è¯·æ±‚å°è¯•è¿æ¥æœåŠ¡ç«¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timerExecutor</span><span class=p>.</span><span class=na>scheduleAtFixedRate</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>clientChannelManager</span><span class=p>.</span><span class=na>reconnect</span><span class=p>(</span><span class=n>getTransactionServiceGroup</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>SCHEDULE_DELAY_MILLS</span><span class=p>,</span><span class=w> </span><span class=n>SCHEDULE_INTERVAL_MILLS</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>NettyClientConfig</span><span class=p>.</span><span class=na>isEnableClientBatchSendRequest</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mergeSendExecutorService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>MAX_MERGE_SEND_THREAD</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=n>MAX_MERGE_SEND_THREAD</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=n>KEEP_ALIVE_TIME</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;&gt;</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=k>new</span><span class=w> </span><span class=n>NamedThreadFactory</span><span class=p>(</span><span class=n>getThreadPrefix</span><span class=p>(),</span><span class=w> </span><span class=n>MAX_MERGE_SEND_THREAD</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mergeSendExecutorService</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>MergedSendRunnable</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¯åŠ¨netty å®¢æˆ·ç«¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>clientBootstrap</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åˆå§‹åŒ–RM
åˆå§‹åŒ–è¿‡ç¨‹è·ŸTMä¸€æ ·ï¼Œä¸‹é¢åªè´´å‡ºç›¸å…³ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>applicationId</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>transactionServiceGroup</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»ºRMçš„nettyå®¢æˆ·ç«¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RmNettyRemotingClient</span><span class=w> </span><span class=n>rmNettyRemotingClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RmNettyRemotingClient</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=n>applicationId</span><span class=p>,</span><span class=w> </span><span class=n>transactionServiceGroup</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è®¾ç½®RMè¿›å»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rmNettyRemotingClient</span><span class=p>.</span><span class=na>setResourceManager</span><span class=p>(</span><span class=n>DefaultResourceManager</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rmNettyRemotingClient</span><span class=p>.</span><span class=na>setTransactionMessageHandler</span><span class=p>(</span><span class=n>DefaultRMHandler</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆå§‹åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rmNettyRemotingClient</span><span class=p>.</span><span class=na>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ³¨å†Œå¤„ç†å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registerProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>initialized</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Found one or more resources that were registered before initialization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resourceManager</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>resourceManager</span><span class=p>.</span><span class=na>getManagedResources</span><span class=p>().</span><span class=na>isEmpty</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isNotBlank</span><span class=p>(</span><span class=n>transactionServiceGroup</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>getClientChannelManager</span><span class=p>().</span><span class=na>reconnect</span><span class=p>(</span><span class=n>transactionServiceGroup</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>registerProcessor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1.registry rm client handle branch commit processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ³¨å†ŒSeata-Serverå‘èµ·branchCommitçš„å¤„ç†Processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RmBranchCommitProcessor</span><span class=w> </span><span class=n>rmBranchCommitProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RmBranchCommitProcessor</span><span class=p>(</span><span class=n>getTransactionMessageHandler</span><span class=p>(),</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_BRANCH_COMMIT</span><span class=p>,</span><span class=w> </span><span class=n>rmBranchCommitProcessor</span><span class=p>,</span><span class=w> </span><span class=n>messageExecutor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2.registry rm client handle branch commit processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ³¨å†ŒSeata-Serverå‘èµ·branchRollbackçš„å¤„ç†Processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RmBranchRollbackProcessor</span><span class=w> </span><span class=n>rmBranchRollbackProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RmBranchRollbackProcessor</span><span class=p>(</span><span class=n>getTransactionMessageHandler</span><span class=p>(),</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_BRANCH_ROLLBACK</span><span class=p>,</span><span class=w> </span><span class=n>rmBranchRollbackProcessor</span><span class=p>,</span><span class=w> </span><span class=n>messageExecutor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 3.registry rm handler undo log processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ³¨å†ŒSeata-Serverå‘èµ·åˆ é™¤undoLogçš„å¤„ç†Processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RmUndoLogProcessor</span><span class=w> </span><span class=n>rmUndoLogProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RmUndoLogProcessor</span><span class=p>(</span><span class=n>getTransactionMessageHandler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_RM_DELETE_UNDOLOG</span><span class=p>,</span><span class=w> </span><span class=n>rmUndoLogProcessor</span><span class=p>,</span><span class=w> </span><span class=n>messageExecutor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 4.registry TC response processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ³¨å†ŒSeata-Serverè¿”å›Responseçš„å¤„ç†Processorï¼Œç”¨äºå¤„ç†ç”±Clientä¸»åŠ¨å‘èµ·Requestï¼Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Seata-Serverè¿”å›çš„Responseã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ClientOnResponseProcessorè´Ÿè´£æŠŠClientå‘é€çš„Requestå’ŒSeata-Server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿”å›çš„Responseå¯¹åº”èµ·æ¥ï¼Œä»è€Œå®ç°Rpc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClientOnResponseProcessor</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>ClientOnResponseProcessor</span><span class=p>(</span><span class=n>mergeMsgMap</span><span class=p>,</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>getFutures</span><span class=p>(),</span><span class=w> </span><span class=n>getTransactionMessageHandler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_SEATA_MERGE_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_BRANCH_REGISTER_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_BRANCH_STATUS_REPORT_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_GLOBAL_LOCK_QUERY_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_REG_RM_RESULT</span><span class=p>,</span><span class=w> </span><span class=n>onResponseProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 5.registry heartbeat message processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¤„ç†Seata-Serverè¿”å›çš„å¿ƒè·³æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClientHeartbeatProcessor</span><span class=w> </span><span class=n>clientHeartbeatProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ClientHeartbeatProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>registerProcessor</span><span class=p>(</span><span class=n>MessageType</span><span class=p>.</span><span class=na>TYPE_HEARTBEAT_MSG</span><span class=p>,</span><span class=w> </span><span class=n>clientHeartbeatProcessor</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å®šæ—¶é‡æ–°å‘é€ RegisterTMRequestï¼ˆRM å®¢æˆ·ç«¯ä¼šå‘é€ RegisterRMRequestï¼‰è¯·æ±‚å°è¯•è¿æ¥æœåŠ¡ç«¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timerExecutor</span><span class=p>.</span><span class=na>scheduleAtFixedRate</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>clientChannelManager</span><span class=p>.</span><span class=na>reconnect</span><span class=p>(</span><span class=n>getTransactionServiceGroup</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>SCHEDULE_DELAY_MILLS</span><span class=p>,</span><span class=w> </span><span class=n>SCHEDULE_INTERVAL_MILLS</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>NettyClientConfig</span><span class=p>.</span><span class=na>isEnableClientBatchSendRequest</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mergeSendExecutorService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>MAX_MERGE_SEND_THREAD</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=n>MAX_MERGE_SEND_THREAD</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=n>KEEP_ALIVE_TIME</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;&gt;</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                          </span><span class=k>new</span><span class=w> </span><span class=n>NamedThreadFactory</span><span class=p>(</span><span class=n>getThreadPrefix</span><span class=p>(),</span><span class=w> </span><span class=n>MAX_MERGE_SEND_THREAD</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mergeSendExecutorService</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>MergedSendRunnable</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¯åŠ¨netty å®¢æˆ·ç«¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>clientBootstrap</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ€»ç»“æ¥è¯´åˆå§‹åŒ–TMå’ŒRMåšçš„äº‹å°±æ˜¯åˆ†åˆ«æ³¨å†Œå‡ ä¸ªå¤„ç†å™¨ä»¥åŠå¯åŠ¨å„è‡ªçš„Nettyå®¢æˆ·ç«¯ã€‚</p><h3 id=æ•°æ®æºä»£ç†><a href=#%e6%95%b0%e6%8d%ae%e6%ba%90%e4%bb%a3%e7%90%86>#</a>
æ•°æ®æºä»£ç†</h3><p>SeataDataSourceAutoConfiguration</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ConditionalOnBean</span><span class=p>(</span><span class=n>DataSource</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ConditionalOnExpression</span><span class=p>(</span><span class=s>&#34;${seata.enabled:true} &amp;&amp; ${seata.enableAutoDataSourceProxy:true} &amp;&amp; ${seata.enable-auto-data-source-proxy:true}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AutoConfigureOrder</span><span class=p>(</span><span class=n>Ordered</span><span class=p>.</span><span class=na>LOWEST_PRECEDENCE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AutoConfigureAfter</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>SeataCoreAutoConfiguration</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeataDataSourceAutoConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * The bean seataAutoDataSourceProxyCreator.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è´Ÿè´£ä¸ºSpringä¸­çš„æ‰€æœ‰DataSourceç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œä»è€Œæ‹¦æˆªSQLçš„æ‰§è¡Œï¼Œåœ¨SQLæ‰§è¡Œå‰åå®ç°seataçš„é€»è¾‘
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=n>BEAN_NAME_SEATA_AUTO_DATA_SOURCE_PROXY_CREATOR</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ConditionalOnMissingBean</span><span class=p>(</span><span class=n>SeataAutoDataSourceProxyCreator</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>SeataAutoDataSourceProxyCreator</span><span class=w> </span><span class=nf>seataAutoDataSourceProxyCreator</span><span class=p>(</span><span class=n>SeataProperties</span><span class=w> </span><span class=n>seataProperties</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SeataAutoDataSourceProxyCreator</span><span class=p>(</span><span class=n>seataProperties</span><span class=p>.</span><span class=na>isUseJdkProxy</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>seataProperties</span><span class=p>.</span><span class=na>getExcludesForAutoProxying</span><span class=p>(),</span><span class=w> </span><span class=n>seataProperties</span><span class=p>.</span><span class=na>getDataSourceProxyMode</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯¥é…ç½®ç±»è¦ç”Ÿæ•ˆçš„æ¡ä»¶æ˜¯<code>${seata.enable:true} && ${seata.enableAutoDataSourceProxy:true} && ${seata.enable-auto-data-source-proxy:true}</code>è¿™å‡ ä¸ªé…ç½®éƒ½ä¸ºtrueï¼Œä½†æ˜¯æˆ‘åœ¨é…ç½®æ–‡ä»¶ä¸­éƒ½è®¾ç½®ä¸ºtrueåä¹Ÿæ²¡ç”Ÿæ•ˆï¼Œä¸çŸ¥é“å“ªé‡Œé—®é¢˜ï¼Œæ‰€ä»¥æˆ‘æ¢ä¸€ç§æ–¹å¼ï¼Œåœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ @EnableAutoDataSourceProxyæ³¨è§£ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=p>(</span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Import</span><span class=p>(</span><span class=n>AutoDataSourceProxyRegistrar</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>EnableAutoDataSourceProxy</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Whether use JDK proxy instead of CGLIB proxy
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return useJdkProxy
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>useJdkProxy</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Specifies which datasource bean are not eligible for auto-proxying
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return excludes
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=nf>excludes</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=p>{};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Data source proxy mode, AT or XA
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return dataSourceProxyMode
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=nf>dataSourceProxyMode</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s>&#34;AT&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯¥æ³¨è§£ä¸Šå¯¼å…¥äº†å¦ä¸€ä¸ªç±»<code>AutoDataSourceProxyRegistrar</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AutoDataSourceProxyRegistrar</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ImportBeanDefinitionRegistrar</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>ATTRIBUTE_KEY_USE_JDK_PROXY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;useJdkProxy&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>ATTRIBUTE_KEY_EXCLUDES</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;excludes&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>ATTRIBUTE_KEY_DATA_SOURCE_PROXY_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;dataSourceProxyMode&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>BEAN_NAME_SEATA_DATA_SOURCE_BEAN_POST_PROCESSOR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;seataDataSourceBeanPostProcessor&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>BEAN_NAME_SEATA_AUTO_DATA_SOURCE_PROXY_CREATOR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;seataAutoDataSourceProxyCreator&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>registerBeanDefinitions</span><span class=p>(</span><span class=n>AnnotationMetadata</span><span class=w> </span><span class=n>importingClassMetadata</span><span class=p>,</span><span class=w> </span><span class=n>BeanDefinitionRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>annotationAttributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>importingClassMetadata</span><span class=p>.</span><span class=na>getAnnotationAttributes</span><span class=p>(</span><span class=n>EnableAutoDataSourceProxy</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>useJdkProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>parseBoolean</span><span class=p>(</span><span class=n>annotationAttributes</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ATTRIBUTE_KEY_USE_JDK_PROXY</span><span class=p>).</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>excludes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=p>)</span><span class=w> </span><span class=n>annotationAttributes</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ATTRIBUTE_KEY_EXCLUDES</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>annotationAttributes</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ATTRIBUTE_KEY_DATA_SOURCE_PROXY_MODE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//register seataDataSourceBeanPostProcessor bean def</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>registry</span><span class=p>.</span><span class=na>containsBeanDefinition</span><span class=p>(</span><span class=n>BEAN_NAME_SEATA_DATA_SOURCE_BEAN_POST_PROCESSOR</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AbstractBeanDefinition</span><span class=w> </span><span class=n>beanDefinition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BeanDefinitionBuilder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>genericBeanDefinition</span><span class=p>(</span><span class=n>SeataDataSourceBeanPostProcessor</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addConstructorArgValue</span><span class=p>(</span><span class=n>excludes</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addConstructorArgValue</span><span class=p>(</span><span class=n>dataSourceProxyMode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getBeanDefinition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>registry</span><span class=p>.</span><span class=na>registerBeanDefinition</span><span class=p>(</span><span class=n>BEAN_NAME_SEATA_DATA_SOURCE_BEAN_POST_PROCESSOR</span><span class=p>,</span><span class=w> </span><span class=n>beanDefinition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//register seataAutoDataSourceProxyCreator bean def</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>registry</span><span class=p>.</span><span class=na>containsBeanDefinition</span><span class=p>(</span><span class=n>BEAN_NAME_SEATA_AUTO_DATA_SOURCE_PROXY_CREATOR</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AbstractBeanDefinition</span><span class=w> </span><span class=n>beanDefinition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BeanDefinitionBuilder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>genericBeanDefinition</span><span class=p>(</span><span class=n>SeataAutoDataSourceProxyCreator</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addConstructorArgValue</span><span class=p>(</span><span class=n>useJdkProxy</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addConstructorArgValue</span><span class=p>(</span><span class=n>excludes</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addConstructorArgValue</span><span class=p>(</span><span class=n>dataSourceProxyMode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getBeanDefinition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>registry</span><span class=p>.</span><span class=na>registerBeanDefinition</span><span class=p>(</span><span class=n>BEAN_NAME_SEATA_AUTO_DATA_SOURCE_PROXY_CREATOR</span><span class=p>,</span><span class=w> </span><span class=n>beanDefinition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>AutoDataSourceProxyRegistrar</code>å®ç°äº†<code>ImportBeanDefinitionRegistrar</code>æ¥å£ï¼Œè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“è¯¥ç±»é¢å¤–æ³¨å†Œäº†<code>BeanDefinition</code>ã€‚é€šè¿‡æºç å¯çŸ¥ï¼Œè¯¥ç±»æ³¨å†Œäº†ä¸¤ä¸ªbeanï¼Œåˆ†åˆ«æ˜¯<code>SeataDataSourceBeanPostProcessor</code>å’Œ<code>SeataAutoDataSourceProxyCreator</code>ã€‚</p><h4 id=seatadatasourcebeanpostprocessor><a href=#seatadatasourcebeanpostprocessor>#</a>
SeataDataSourceBeanPostProcessor</h4><p>è¯¥ç±»æ˜¯ä¸€ä¸ªBeanPostProcessorï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥ç”Ÿæˆæ•°æ®æºä»£ç†çš„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeataDataSourceBeanPostProcessor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>BeanPostProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>LOGGER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>SeataDataSourceBeanPostProcessor</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>excludes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>BranchType</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SeataDataSourceBeanPostProcessor</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>excludes</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>excludes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>excludes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>dataSourceProxyMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BranchType</span><span class=p>.</span><span class=na>XA</span><span class=p>.</span><span class=na>name</span><span class=p>().</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>dataSourceProxyMode</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>BranchType</span><span class=p>.</span><span class=na>XA</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>BranchType</span><span class=p>.</span><span class=na>AT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>postProcessBeforeInitialization</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>postProcessAfterInitialization</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>BeansException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bean</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>DataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//When not in the excludes, put and init proxy.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>excludes</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>bean</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// è¿™é‡Œåªæ˜¯ç”Ÿæˆä»£ç†ï¼Œå¹¶ä¸è¿”å›ä»£ç†ï¼Œè¿”å›çš„è¿˜æ˜¯çœŸå®æ•°æ®æºï¼Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ¯•ç«Ÿä¸æ˜¯æ¯ä¸ªsqléƒ½éœ€è¦ä»£ç†ï¼Œåœ¨éœ€è¦ä½¿ç”¨ä»£ç†çš„æ—¶å€™å†å–å‡ºæ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>DataSourceProxyHolder</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>putDataSource</span><span class=p>((</span><span class=n>DataSource</span><span class=p>)</span><span class=w> </span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¦‚æœæ˜¯ä»£ç†æ•°æ®æºï¼Œåˆ™è¿”å›çœŸå®æ•°æ®æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bean</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>SeataDataSourceProxy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Unwrap the bean of the data source,&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34; and return the original data source to replace the data source proxy.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>SeataDataSourceProxy</span><span class=p>)</span><span class=w> </span><span class=n>bean</span><span class=p>).</span><span class=na>getTargetDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>DataSourceProxyHolderæ˜¯ç”¨æ¥å­˜æ”¾ä»£ç†æ•°æ®æºçš„ï¼Œå¦‚æœå½“å‰beanæ˜¯DataSourceï¼Œåˆ™ä¼šä¸ºè¯¥DataSourceç”Ÿæˆä¸€ä¸ªä»£ç†DataSourceã€‚åœ¨putDataSourceæ–¹æ³•ä¸­ï¼Œä¼šè¿›è¡Œæ•°æ®æºä»£ç†ç±»çš„åˆ›å»ºï¼Œå½“ç„¶ï¼Œè¯¥æ–¹æ³•é™¤äº†åˆ›å»ºæ•°æ®æºä»£ç†ï¼Œè·å–æ•°æ®æºä»£ç†ä¹Ÿæ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>SeataDataSourceProxy</span><span class=w> </span><span class=nf>putDataSource</span><span class=p>(</span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w> </span><span class=n>BranchType</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DataSource</span><span class=w> </span><span class=n>originalDataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœå·²ç»æ˜¯ä»£ç†æ•°æ®æºå¹¶ä¸”äº‹åŠ¡æ¨¡å¼ä¹Ÿè·Ÿæƒ³è¦çš„ä¸€æ ·ï¼Œåˆ™ç›´æ¥è¿”å›äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dataSource</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>SeataDataSourceProxy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SeataDataSourceProxy</span><span class=w> </span><span class=n>dataSourceProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>SeataDataSourceProxy</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°±æ˜¯æƒ³è¦çš„ä»£ç†ç±»å°±ç›´æ¥è¿”å›äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dataSourceProxyMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>dataSourceProxy</span><span class=p>.</span><span class=na>getBranchType</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>SeataDataSourceProxy</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·å–åŸæ•°æ®æºï¼Œä¸‹é¢æ ¹æ®è¯¥æ•°æ®æºåˆ›å»ºæˆ–è·å–æ•°æ®æºä»£ç†ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>originalDataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSourceProxy</span><span class=p>.</span><span class=na>getTargetDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>originalDataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä»ç¼“å­˜ä¸­è·å–çœŸå®æ•°æ®æºå¯¹åº”çš„ä»£ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SeataDataSourceProxy</span><span class=w> </span><span class=n>dsProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSourceProxyMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>originalDataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dsProxy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>dataSourceProxyMap</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dsProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSourceProxyMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>originalDataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dsProxy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ²¡è·å–åˆ°å°±æ ¹æ®äº‹åŠ¡æ¨¡å¼å’ŒçœŸå®æ•°æ®æºåˆ›å»ºä¸€ä¸ªä»£ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>dsProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createDsProxyByMode</span><span class=p>(</span><span class=n>dataSourceProxyMode</span><span class=p>,</span><span class=w> </span><span class=n>originalDataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ”¾è¿›ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>dataSourceProxyMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>originalDataSource</span><span class=p>,</span><span class=w> </span><span class=n>dsProxy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>dsProxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>XAæ¨¡å¼å°±åˆ›å»ºDataSourceProxyXAï¼Œå…¶ä»–æ¨¡å¼åˆ›å»ºDataSourceProxã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>SeataDataSourceProxy</span><span class=w> </span><span class=nf>createDsProxyByMode</span><span class=p>(</span><span class=n>BranchType</span><span class=w> </span><span class=n>mode</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>originDs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>BranchType</span><span class=p>.</span><span class=na>XA</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>mode</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProxyXA</span><span class=p>(</span><span class=n>originDs</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProxy</span><span class=p>(</span><span class=n>originDs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=seataautodatasourceproxycreator><a href=#seataautodatasourceproxycreator>#</a>
SeataAutoDataSourceProxyCreator</h4><p>ä¸Šé¢ä¸ºæ¯ä¸ªæ•°æ®æºç”Ÿæˆäº†seataçš„ä»£ç†å¯¹è±¡ï¼Œä½†æ˜¯è¯¥ä»£ç†å¯¹è±¡å¹¶ä¸èƒ½é€šè¿‡AOPåˆ‡å…¥ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦ä¸€ä¸ªAOPä»£ç†å¯¹è±¡ã€‚SeataAutoDataSourceProxyCreatorä¹Ÿæ˜¯ç»§æ‰¿äº†AbstractAutoProxyCreatorç±»ï¼Œç»§æ‰¿è¯¥ç±»å°±å¯ä»¥å¯¹æŒ‡å®šçš„beanç”ŸæˆAOPä»£ç†ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeataAutoDataSourceProxyCreator</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractAutoProxyCreator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>LOGGER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>SeataAutoDataSourceProxyCreator</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>excludes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Advisor</span><span class=w> </span><span class=n>advisor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SeataAutoDataSourceProxyCreator</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>useJdkProxy</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>excludes</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>excludes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>excludes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>advisor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultIntroductionAdvisor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>SeataAutoDataSourceProxyAdvice</span><span class=p>(</span><span class=n>dataSourceProxyMode</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setProxyTargetClass</span><span class=p>(</span><span class=o>!</span><span class=n>useJdkProxy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=nf>getAdvicesAndAdvisorsForBean</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>beanClass</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>TargetSource</span><span class=w> </span><span class=n>customTargetSource</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>BeansException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isInfoEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Auto proxy of [{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>advisor</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>shouldSkip</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>beanClass</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¿™ä¸ªç±»åªå¯¹DataSourceç”Ÿæˆä»£ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=n>DataSource</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>beanClass</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>SeataProxy</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>beanClass</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>excludes</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>beanClass</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä»shouldSkipæ–¹æ³•å¯çŸ¥ï¼Œåªä¼šå¯¹DataSourceç”Ÿæˆä»£ç†ï¼Œè€Œå®ƒæ·»åŠ çš„å¢å¼ºé€»è¾‘åœ¨SeataAutoDataSourceProxyAdviceå†…ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å¯¹DataSourceè¿›è¡Œå¢å¼ºï¼Œä»£ç†DataSourceä¸­çš„æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author xingfudeshi@gmail.com
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeataAutoDataSourceProxyAdvice</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>MethodInterceptor</span><span class=p>,</span><span class=w> </span><span class=n>IntroductionInfo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>BranchType</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>SeataDataSourceProxy</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataSourceProxyClazz</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SeataAutoDataSourceProxyAdvice</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>BranchType</span><span class=p>.</span><span class=na>AT</span><span class=p>.</span><span class=na>name</span><span class=p>().</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>dataSourceProxyMode</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>dataSourceProxyMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BranchType</span><span class=p>.</span><span class=na>AT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>dataSourceProxyClazz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DataSourceProxy</span><span class=p>.</span><span class=na>class</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>BranchType</span><span class=p>.</span><span class=na>XA</span><span class=p>.</span><span class=na>name</span><span class=p>().</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>dataSourceProxyMode</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>dataSourceProxyMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BranchType</span><span class=p>.</span><span class=na>XA</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>dataSourceProxyClazz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DataSourceProxyXA</span><span class=p>.</span><span class=na>class</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Unknown dataSourceProxyMode: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//Set the default branch type in the RootContext.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RootContext</span><span class=p>.</span><span class=na>setDefaultBranchType</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>dataSourceProxyMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>MethodInvocation</span><span class=w> </span><span class=n>invocation</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœä¸æ˜¯åœ¨@GlobalLockæ–¹æ³•æˆ–äº‹åŠ¡æ¨¡å¼è·Ÿå½“å‰çš„ä¸åŒ¹é…ï¼Œåˆ™ç›´æ¥è°ƒç”¨åŸæ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>RootContext</span><span class=p>.</span><span class=na>requireGlobalLock</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>RootContext</span><span class=p>.</span><span class=na>getBranchType</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>getMethod</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>getArguments</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>findDeclaredMethod</span><span class=p>(</span><span class=n>dataSourceProxyClazz</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å–seataåˆ›å»ºçš„ä»£ç†æ•°æ®æºï¼Œè°ƒç”¨ä»£ç†æ•°æ®æºçš„æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>SeataDataSourceProxy</span><span class=w> </span><span class=n>dataSourceProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DataSourceProxyHolder</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>putDataSource</span><span class=p>((</span><span class=n>DataSource</span><span class=p>)</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>getThis</span><span class=p>(),</span><span class=w> </span><span class=n>dataSourceProxyMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>dataSourceProxy</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;[]</span><span class=w> </span><span class=n>getInterfaces</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>SeataProxy</span><span class=p>.</span><span class=na>class</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å½“è°ƒç”¨DataSourceçš„æ–¹æ³•æ—¶ï¼Œå°±ä¼šé€šè¿‡AOPä»£ç†å¯¹è±¡è°ƒç”¨åˆ°SeataDataSourceProxyå®ç°ç±»çš„æ–¹æ³•ï¼Œå³seataçš„ä»£ç†ã€‚</p><h3 id=web-mvcä»£ç†><a href=#web-mvc%e4%bb%a3%e7%90%86>#</a>
Web MVCä»£ç†</h3><p>è¿™ä¸ªçš„è¯æ¯”è¾ƒç®€å•ï¼Œç›´æ¥è´´ä¸Šç›¸å…³ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Auto bean add for spring webmvc if in springboot env.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=p>(</span><span class=n>proxyBeanMethods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ConditionalOnWebApplication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ConditionalOnMissingBean</span><span class=p>(</span><span class=n>SeataWebMvcConfigurer</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ConditionalOnProperty</span><span class=p>(</span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HTTP_PREFIX</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;interceptor-enabled&#34;</span><span class=p>,</span><span class=w> </span><span class=n>havingValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>,</span><span class=w> </span><span class=n>matchIfMissing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AutoConfigureOrder</span><span class=p>(</span><span class=n>Ordered</span><span class=p>.</span><span class=na>LOWEST_PRECEDENCE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeataHttpAutoConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * The Jakarta seata web mvc configurer.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the seata web mvc configurer
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ConditionalOnClass</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;jakarta.servlet.http.HttpServletRequest&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>JakartaSeataWebMvcConfigurer</span><span class=w> </span><span class=nf>jakartaSeataWebMvcConfigurer</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JakartaSeataWebMvcConfigurer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * The Javax seata web mvc configurer.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the seata web mvc configurer
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ConditionalOnMissingBean</span><span class=p>(</span><span class=n>JakartaSeataWebMvcConfigurer</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SeataWebMvcConfigurer</span><span class=w> </span><span class=nf>seataWebMvcConfigurer</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SeataWebMvcConfigurer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç„¶åæ¥ç€å¾€é‡Œé¢çœ‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * The Seata Web Mvc Configurer
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SeataWebMvcConfigurer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>WebMvcConfigurerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addInterceptors</span><span class=p>(</span><span class=n>InterceptorRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registry</span><span class=p>.</span><span class=na>addInterceptor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TransactionPropagationInterceptor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>WebMvcConfigurerAdapter</code>å¯ä»¥ä»¥çµæ´»çš„æ–¹å¼æ‰©å±•å’Œå®šåˆ¶ Spring MVC çš„é…ç½®ï¼Œç„¶åçš„è¯çœ‹<code>TransactionPropagationInterceptor</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TransactionPropagationInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptorAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>LOGGER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>TransactionPropagationInterceptor</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>rpcXid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>RootContext</span><span class=p>.</span><span class=na>KEY_XID</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>bindXid</span><span class=p>(</span><span class=n>rpcXid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCompletion</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>RootContext</span><span class=p>.</span><span class=na>inGlobalTransaction</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>rpcXid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>RootContext</span><span class=p>.</span><span class=na>KEY_XID</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>cleanXid</span><span class=p>(</span><span class=n>rpcXid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>bindXid</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>rpcXid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>xid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RootContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isDebugEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;xid in RootContext[{}] xid in HttpContext[{}]&#34;</span><span class=p>,</span><span class=w> </span><span class=n>xid</span><span class=p>,</span><span class=w> </span><span class=n>rpcXid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isBlank</span><span class=p>(</span><span class=n>xid</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isNotBlank</span><span class=p>(</span><span class=n>rpcXid</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RootContext</span><span class=p>.</span><span class=na>bind</span><span class=p>(</span><span class=n>rpcXid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isDebugEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;bind[{}] to RootContext&#34;</span><span class=p>,</span><span class=w> </span><span class=n>rpcXid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cleanXid</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>rpcXid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>XidResource</span><span class=p>.</span><span class=na>cleanXid</span><span class=p>(</span><span class=n>rpcXid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªæ–¹æ³•å°±ç›¸å½“äºåˆ›å»ºå¯¹åº”çš„é€‚é…å™¨ï¼Œé€šè¿‡è·å–å¯¹åº”çš„xidï¼Œä»è€Œè¿›è¡Œé€‚é…ã€‚</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Apache License 2.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({avatar:"retro",avatarcdn:"https://sdn.geekzu.org/avatar/",dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],highlight:!0,js:"https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js",lang:"zh-CN",locale:{admin:"Admin",placeholder:null},meta:["nick","mail","link"],pageSize:20,placeholder:"",requiredMeta:["name","email","url"],serverURL:"https://waline-line-git-main-zrsaber.vercel.app",uploadimage:!1,visitor:!0})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Runqi Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>