<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='ä¸‹é¢å¼€å§‹è®²è§£å¯¹åº”R2Convå¯¹åº”çš„ æ¨¡å—ï¼Œè¿™é‡Œçš„è¯æˆ‘ä»¬è¿˜æ˜¯ä»ReResNetä¸­è¿›è¡Œè¿è¡Œï¼Œç„¶åæ‹¿åˆ°å¯¹åº”çš„æ•°æ®ï¼Œåœ¨æ‹¿åˆ°å¯¹åº”çš„æ•°æ®ä¹‹åï¼Œå°†é‡Œé¢çš„å€¼è¿›è¡Œä¼ é€’ï¼Œç„¶åä¾›é¢è¿›è¡Œä½¿ç”¨ã€‚ åœ¨å¯¹åº”çš„å‰é¢ä¸‰èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºäº†å¯¹åº”å¾ªç¯ç¾¤ï¼Œè¾“å…¥ç±»å‹ï¼Œè¾“å‡ºç±»å‹ï¼Œè¿™ä¸ªé‡Œé¢ï¼Œæ˜¯å°†é‡Œé¢å†…å®¹è¿›è¡Œåˆ©ç”¨ã€‚ è¿˜æ˜¯ä»ReResNetä¸­å¼€å§‹çœ‹èµ·ï¼Œåœ¨æˆ‘ä»¬è¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šè¿è¡Œä¸‹é¢è¯­å¥ï¼š 1 self._make_stem_layer(in_channels, stem_channels) ç„¶åçœ‹è¿™ä¸ªå‡½æ•°é‡Œé¢çš„å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 def _make_stem_layer(self, in_channels, stem_channels): """Build stem layer.""" if not self.deep_stem: self.conv1 = ennTrivialConv( in_channels, stem_channels, kernel_size=7, stride=2, padding=3) self.norm1_name, norm1 = build_enn_norm_layer( stem_channels, postfix=1) self.add_module(self.norm1_name, norm1) self.relu = ennReLU(stem_channels) self.maxpool = ennMaxPool( stem_channels, kernel_size=3, stride=2, padding=1) ç„¶åç»§ç»­çœ‹ennTrivialConvè¿™ä¸ªå‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 def ennTrivialConv(inplanes, outplanes, kernel_size=3, stride=1, padding=0, groups=1, bias=False, dilation=1): """enn convolution with trivial input feature.'><title>e2cnn å†…å®¹ç†è§£-R2Conv è¯¦è§£</title>
<link rel=canonical href=https://runqizhao.cn/p/e2cnn-%E5%86%85%E5%AE%B9%E7%90%86%E8%A7%A3-r2conv-%E8%AF%A6%E8%A7%A3/><link rel=stylesheet href=/scss/style.min.8e60baf4cd3fc55968717a6e39762f4d28ed7ef6007566b6c7970ad0fe907198.css><meta property='og:title' content="e2cnn å†…å®¹ç†è§£-R2Conv è¯¦è§£"><meta property='og:description' content='ä¸‹é¢å¼€å§‹è®²è§£å¯¹åº”R2Convå¯¹åº”çš„ æ¨¡å—ï¼Œè¿™é‡Œçš„è¯æˆ‘ä»¬è¿˜æ˜¯ä»ReResNetä¸­è¿›è¡Œè¿è¡Œï¼Œç„¶åæ‹¿åˆ°å¯¹åº”çš„æ•°æ®ï¼Œåœ¨æ‹¿åˆ°å¯¹åº”çš„æ•°æ®ä¹‹åï¼Œå°†é‡Œé¢çš„å€¼è¿›è¡Œä¼ é€’ï¼Œç„¶åä¾›é¢è¿›è¡Œä½¿ç”¨ã€‚ åœ¨å¯¹åº”çš„å‰é¢ä¸‰èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºäº†å¯¹åº”å¾ªç¯ç¾¤ï¼Œè¾“å…¥ç±»å‹ï¼Œè¾“å‡ºç±»å‹ï¼Œè¿™ä¸ªé‡Œé¢ï¼Œæ˜¯å°†é‡Œé¢å†…å®¹è¿›è¡Œåˆ©ç”¨ã€‚ è¿˜æ˜¯ä»ReResNetä¸­å¼€å§‹çœ‹èµ·ï¼Œåœ¨æˆ‘ä»¬è¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šè¿è¡Œä¸‹é¢è¯­å¥ï¼š 1 self._make_stem_layer(in_channels, stem_channels) ç„¶åçœ‹è¿™ä¸ªå‡½æ•°é‡Œé¢çš„å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 def _make_stem_layer(self, in_channels, stem_channels): """Build stem layer.""" if not self.deep_stem: self.conv1 = ennTrivialConv( in_channels, stem_channels, kernel_size=7, stride=2, padding=3) self.norm1_name, norm1 = build_enn_norm_layer( stem_channels, postfix=1) self.add_module(self.norm1_name, norm1) self.relu = ennReLU(stem_channels) self.maxpool = ennMaxPool( stem_channels, kernel_size=3, stride=2, padding=1) ç„¶åç»§ç»­çœ‹ennTrivialConvè¿™ä¸ªå‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 def ennTrivialConv(inplanes, outplanes, kernel_size=3, stride=1, padding=0, groups=1, bias=False, dilation=1): """enn convolution with trivial input feature.'><meta property='og:url' content='https://runqizhao.cn/p/e2cnn-%E5%86%85%E5%AE%B9%E7%90%86%E8%A7%A3-r2conv-%E8%AF%A6%E8%A7%A3/'><meta property='og:site_name' content='Runqi Blog'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='æœºå™¨å­¦ä¹ '><meta property='article:tag' content='æºç é˜…è¯»'><meta property='article:tag' content='ç¾¤è®º'><meta property='article:published_time' content='2023-12-04T18:47:52+08:00'><meta property='article:modified_time' content='2023-12-04T18:47:52+08:00'><meta name=twitter:title content="e2cnn å†…å®¹ç†è§£-R2Conv è¯¦è§£"><meta name=twitter:description content='ä¸‹é¢å¼€å§‹è®²è§£å¯¹åº”R2Convå¯¹åº”çš„ æ¨¡å—ï¼Œè¿™é‡Œçš„è¯æˆ‘ä»¬è¿˜æ˜¯ä»ReResNetä¸­è¿›è¡Œè¿è¡Œï¼Œç„¶åæ‹¿åˆ°å¯¹åº”çš„æ•°æ®ï¼Œåœ¨æ‹¿åˆ°å¯¹åº”çš„æ•°æ®ä¹‹åï¼Œå°†é‡Œé¢çš„å€¼è¿›è¡Œä¼ é€’ï¼Œç„¶åä¾›é¢è¿›è¡Œä½¿ç”¨ã€‚ åœ¨å¯¹åº”çš„å‰é¢ä¸‰èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºäº†å¯¹åº”å¾ªç¯ç¾¤ï¼Œè¾“å…¥ç±»å‹ï¼Œè¾“å‡ºç±»å‹ï¼Œè¿™ä¸ªé‡Œé¢ï¼Œæ˜¯å°†é‡Œé¢å†…å®¹è¿›è¡Œåˆ©ç”¨ã€‚ è¿˜æ˜¯ä»ReResNetä¸­å¼€å§‹çœ‹èµ·ï¼Œåœ¨æˆ‘ä»¬è¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šè¿è¡Œä¸‹é¢è¯­å¥ï¼š 1 self._make_stem_layer(in_channels, stem_channels) ç„¶åçœ‹è¿™ä¸ªå‡½æ•°é‡Œé¢çš„å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 def _make_stem_layer(self, in_channels, stem_channels): """Build stem layer.""" if not self.deep_stem: self.conv1 = ennTrivialConv( in_channels, stem_channels, kernel_size=7, stride=2, padding=3) self.norm1_name, norm1 = build_enn_norm_layer( stem_channels, postfix=1) self.add_module(self.norm1_name, norm1) self.relu = ennReLU(stem_channels) self.maxpool = ennMaxPool( stem_channels, kernel_size=3, stride=2, padding=1) ç„¶åç»§ç»­çœ‹ennTrivialConvè¿™ä¸ªå‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 def ennTrivialConv(inplanes, outplanes, kernel_size=3, stride=1, padding=0, groups=1, bias=False, dilation=1): """enn convolution with trivial input feature.'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu9b4ee4aab7d2c9a136b427e2430a0345_27821_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>Runqi Blog</a></h1><h2 class=site-description>Stay foolish stay hungry</h2></div></header><ol class=menu-social><li><a href=https://github.com/runqi-zhao target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/>æœºå™¨å­¦ä¹ </a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/e2cnn-%E5%86%85%E5%AE%B9%E7%90%86%E8%A7%A3-r2conv-%E8%AF%A6%E8%A7%A3/>e2cnn å†…å®¹ç†è§£-R2Conv è¯¦è§£</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Dec 04, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>22 minute read</time></div></footer></div></header><section class=article-content><p>ä¸‹é¢å¼€å§‹è®²è§£å¯¹åº”R2Convå¯¹åº”çš„ æ¨¡å—ï¼Œè¿™é‡Œçš„è¯æˆ‘ä»¬è¿˜æ˜¯ä»ReResNetä¸­è¿›è¡Œè¿è¡Œï¼Œç„¶åæ‹¿åˆ°å¯¹åº”çš„æ•°æ®ï¼Œåœ¨æ‹¿åˆ°å¯¹åº”çš„æ•°æ®ä¹‹åï¼Œå°†é‡Œé¢çš„å€¼è¿›è¡Œä¼ é€’ï¼Œç„¶åä¾›é¢è¿›è¡Œä½¿ç”¨ã€‚</p><p>åœ¨å¯¹åº”çš„å‰é¢ä¸‰èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºäº†å¯¹åº”å¾ªç¯ç¾¤ï¼Œè¾“å…¥ç±»å‹ï¼Œè¾“å‡ºç±»å‹ï¼Œè¿™ä¸ªé‡Œé¢ï¼Œæ˜¯å°†é‡Œé¢å†…å®¹è¿›è¡Œåˆ©ç”¨ã€‚</p><p>è¿˜æ˜¯ä»ReResNetä¸­å¼€å§‹çœ‹èµ·ï¼Œåœ¨æˆ‘ä»¬è¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šè¿è¡Œä¸‹é¢è¯­å¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>_make_stem_layer</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>stem_channels</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åçœ‹è¿™ä¸ªå‡½æ•°é‡Œé¢çš„å†…å®¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_make_stem_layer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>in_channels</span><span class=p>,</span> <span class=n>stem_channels</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Build stem layer.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>deep_stem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv1</span> <span class=o>=</span> <span class=n>ennTrivialConv</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>in_channels</span><span class=p>,</span> <span class=n>stem_channels</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>norm1_name</span><span class=p>,</span> <span class=n>norm1</span> <span class=o>=</span> <span class=n>build_enn_norm_layer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>stem_channels</span><span class=p>,</span> <span class=n>postfix</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>add_module</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>norm1_name</span><span class=p>,</span> <span class=n>norm1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu</span> <span class=o>=</span> <span class=n>ennReLU</span><span class=p>(</span><span class=n>stem_channels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>maxpool</span> <span class=o>=</span> <span class=n>ennMaxPool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>stem_channels</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åç»§ç»­çœ‹ennTrivialConvè¿™ä¸ªå‡½æ•°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>ennTrivialConv</span><span class=p>(</span><span class=n>inplanes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>outplanes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>kernel_size</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>stride</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>padding</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>groups</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>dilation</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;enn convolution with trivial input feature.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        in_channels (List[int]): Number of input channels per scale.
</span></span></span><span class=line><span class=cl><span class=s2>        out_channels (int): Number of output channels (used at each scale).
</span></span></span><span class=line><span class=cl><span class=s2>        kernel_size (int, optional): The size of kernel.
</span></span></span><span class=line><span class=cl><span class=s2>        stride (int, optional): Stride of the convolution. Default: 1.
</span></span></span><span class=line><span class=cl><span class=s2>        padding (int or tuple): Zero-padding added to both sides of the input.
</span></span></span><span class=line><span class=cl><span class=s2>            Default: 0.
</span></span></span><span class=line><span class=cl><span class=s2>        groups (int): Number of blocked connections from input.
</span></span></span><span class=line><span class=cl><span class=s2>            channels to output channels. Default: 1.
</span></span></span><span class=line><span class=cl><span class=s2>        bias (bool): If True, adds a learnable bias to the output.
</span></span></span><span class=line><span class=cl><span class=s2>            Default: False.
</span></span></span><span class=line><span class=cl><span class=s2>        dilation (int or tuple): Spacing between kernel elements. Default: 1.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>in_type</span> <span class=o>=</span> <span class=n>build_enn_trivial_feature</span><span class=p>(</span><span class=n>inplanes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out_type</span> <span class=o>=</span> <span class=n>build_enn_divide_feature</span><span class=p>(</span><span class=n>outplanes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>enn</span><span class=o>.</span><span class=n>R2Conv</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>in_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>out_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>kernel_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>stride</span><span class=o>=</span><span class=n>stride</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>padding</span><span class=o>=</span><span class=n>padding</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>groups</span><span class=o>=</span><span class=n>groups</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bias</span><span class=o>=</span><span class=n>bias</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dilation</span><span class=o>=</span><span class=n>dilation</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>sigma</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>frequencies_cutoff</span><span class=o>=</span><span class=k>lambda</span> <span class=n>r</span><span class=p>:</span> <span class=mi>3</span> <span class=o>*</span> <span class=n>r</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„è¯åœ¨å‰ä¸¤è®²ä¸­ä»¥åŠè¯´æ˜äº†å¯¹åº”çš„ è¾“å…¥ç±»å‹å’Œè¾“å‡ºç±»å‹ï¼Œè¿™é‡Œçš„è¯ç›´æ¥å°†å¯¹åº”çš„å†…å®¹è¿›è¡Œæˆªå›¾ï¼Œä¸å†è¿›è¡Œè¯¦ç»†é˜è¿°ï¼Œå¦‚æœè¯´ä¸äº†è§£çš„è¯å»çœ‹å‰é¢ä¸¤èŠ‚ã€‚</p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312042048059.png loading=lazy></p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312042048204.png loading=lazy></p><p>okï¼ŒçŸ¥é“äº†è¿™äº›å†…å®¹ ï¼Œä¸‹é¢æ¥çœ‹æœ¬æ–‡çš„æ ¸å¿ƒå‡½æ•° ï¼šR2Convå‡½æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>R2Conv</span><span class=p>(</span><span class=n>EquivariantModule</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>in_type</span><span class=p>:</span> <span class=n>FieldType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>out_type</span><span class=p>:</span> <span class=n>FieldType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>kernel_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>padding</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>stride</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>dilation</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>padding_mode</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;zeros&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>groups</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>bias</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>basisexpansion</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;blocks&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>sigma</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span> <span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>frequencies_cutoff</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=n>Callable</span><span class=p>[[</span><span class=nb>float</span><span class=p>],</span> <span class=nb>int</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>rings</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>maximum_offset</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>recompute</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>basis_filter</span><span class=p>:</span> <span class=n>Callable</span><span class=p>[[</span><span class=nb>dict</span><span class=p>],</span> <span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>initialize</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=sa>r</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        G-steerable planar convolution mapping between the input and output :class:`~e2cnn.nn.FieldType` s specified by
</span></span></span><span class=line><span class=cl><span class=s2>        the parameters ``in_type`` and ``out_type``.
</span></span></span><span class=line><span class=cl><span class=s2>        This operation is equivariant under the action of :math:`\R^2\rtimes G` where :math:`G` is the
</span></span></span><span class=line><span class=cl><span class=s2>        :attr:`e2cnn.nn.FieldType.fibergroup` of ``in_type`` and ``out_type``.
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Specifically, let :math:`\rho_\text</span><span class=si>{in}</span><span class=s2>: G \to \GL{\R^{c_\text</span><span class=si>{in}</span><span class=s2>}}` and
</span></span></span><span class=line><span class=cl><span class=s2>        :math:`\rho_\text</span><span class=si>{out}</span><span class=s2>: G \to \GL{\R^{c_\text</span><span class=si>{out}</span><span class=s2>}}` be the representations specified by the input and output
</span></span></span><span class=line><span class=cl><span class=s2>        field types.
</span></span></span><span class=line><span class=cl><span class=s2>        Then :class:`~e2cnn.nn.R2Conv` guarantees an equivariant mapping
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        .. math::
</span></span></span><span class=line><span class=cl><span class=s2>            \kappa \star [\mathcal</span><span class=si>{T}</span><span class=s2>^\text</span><span class=si>{in}</span><span class=s2>_{g,u} . f] = \mathcal</span><span class=si>{T}</span><span class=s2>^\text</span><span class=si>{out}</span><span class=s2>_{g,u} . [\kappa \star f] \qquad\qquad \forall g \in G, u \in \R^2
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>        where the transformation of the input and output fields are given by
</span></span></span><span class=line><span class=cl><span class=s2> 
</span></span></span><span class=line><span class=cl><span class=s2>        .. math::
</span></span></span><span class=line><span class=cl><span class=s2>            [\mathcal</span><span class=si>{T}</span><span class=s2>^\text</span><span class=si>{in}</span><span class=s2>_{g,u} . f](x) &amp;= \rho_\text</span><span class=si>{in}</span><span class=s2>(g)f(g^{-1} (x - u)) \\
</span></span></span><span class=line><span class=cl><span class=s2>            [\mathcal</span><span class=si>{T}</span><span class=s2>^\text</span><span class=si>{out}</span><span class=s2>_{g,u} . f](x) &amp;= \rho_\text</span><span class=si>{out}</span><span class=s2>(g)f(g^{-1} (x - u)) \\
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        The equivariance of G-steerable convolutions is guaranteed by restricting the space of convolution kernels to an
</span></span></span><span class=line><span class=cl><span class=s2>        equivariant subspace.
</span></span></span><span class=line><span class=cl><span class=s2>        As proven in `3D Steerable CNNs &lt;https://arxiv.org/abs/1807.02547&gt;`_, this parametrizes the *most general
</span></span></span><span class=line><span class=cl><span class=s2>        equivariant convolutional map* between the input and output fields.
</span></span></span><span class=line><span class=cl><span class=s2>        For feature fields on :math:`\R^2` (e.g. images), the complete G-steerable kernel spaces for :math:`G \leq \O2`
</span></span></span><span class=line><span class=cl><span class=s2>        is derived in `General E(2)-Equivariant Steerable CNNs &lt;https://arxiv.org/abs/1911.08251&gt;`_.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        During training, in each forward pass the module expands the basis of G-steerable kernels with learned weights
</span></span></span><span class=line><span class=cl><span class=s2>        before calling :func:`torch.nn.functional.conv2d`.
</span></span></span><span class=line><span class=cl><span class=s2>        When :meth:`~torch.nn.Module.eval()` is called, the filter is built with the current trained weights and stored
</span></span></span><span class=line><span class=cl><span class=s2>        for future reuse such that no overhead of expanding the kernel remains.
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        .. warning ::
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>            When :meth:`~torch.nn.Module.train()` is called, the attributes :attr:`~e2cnn.nn.R2Conv.filter` and
</span></span></span><span class=line><span class=cl><span class=s2>            :attr:`~e2cnn.nn.R2Conv.expanded_bias` are discarded to avoid situations of mismatch with the
</span></span></span><span class=line><span class=cl><span class=s2>            learnable expansion coefficients.
</span></span></span><span class=line><span class=cl><span class=s2>            See also :meth:`e2cnn.nn.R2Conv.train`.
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>            This behaviour can cause problems when storing the :meth:`~torch.nn.Module.state_dict` of a model while in
</span></span></span><span class=line><span class=cl><span class=s2>            a mode and lately loading it in a model with a different mode, as the attributes of the class change.
</span></span></span><span class=line><span class=cl><span class=s2>            To avoid this issue, we recommend converting the model to eval mode before storing or loading the state
</span></span></span><span class=line><span class=cl><span class=s2>            dictionary.
</span></span></span><span class=line><span class=cl><span class=s2> 
</span></span></span><span class=line><span class=cl><span class=s2> 
</span></span></span><span class=line><span class=cl><span class=s2>        The learnable expansion coefficients of the this module can be initialized with the methods in
</span></span></span><span class=line><span class=cl><span class=s2>        :mod:`e2cnn.nn.init`.
</span></span></span><span class=line><span class=cl><span class=s2>        By default, the weights are initialized in the constructors using :func:`~e2cnn.nn.init.generalized_he_init`.
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        .. warning ::
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>            This initialization procedure can be extremely slow for wide layers.
</span></span></span><span class=line><span class=cl><span class=s2>            In case initializing the model is not required (e.g. before loading the state dict of a pre-trained model)
</span></span></span><span class=line><span class=cl><span class=s2>            or another initialization method is preferred (e.g. :func:`~e2cnn.nn.init.deltaorthonormal_init`), the
</span></span></span><span class=line><span class=cl><span class=s2>            parameter ``initialize`` can be set to ``False`` to avoid unnecessary overhead.
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        The parameters ``basisexpansion``, ``sigma``, ``frequencies_cutoff``, ``rings`` and ``maximum_offset`` are
</span></span></span><span class=line><span class=cl><span class=s2>        optional parameters used to control how the basis for the filters is built, how it is sampled on the filter
</span></span></span><span class=line><span class=cl><span class=s2>        grid and how it is expanded to build the filter. We suggest to keep these default values.
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            in_type (FieldType): the type of the input field, specifying its transformation law
</span></span></span><span class=line><span class=cl><span class=s2>            out_type (FieldType): the type of the output field, specifying its transformation law
</span></span></span><span class=line><span class=cl><span class=s2>            kernel_size (int): the size of the (square) filter
</span></span></span><span class=line><span class=cl><span class=s2>            padding (int, optional): implicit zero paddings on both sides of the input. Default: ``0``
</span></span></span><span class=line><span class=cl><span class=s2>            padding_mode(str, optional): ``zeros``, ``reflect``, ``replicate`` or ``circular``. Default: ``zeros``
</span></span></span><span class=line><span class=cl><span class=s2>            stride (int, optional): the stride of the kernel. Default: ``1``
</span></span></span><span class=line><span class=cl><span class=s2>            dilation (int, optional): the spacing between kernel elements. Default: ``1``
</span></span></span><span class=line><span class=cl><span class=s2>            groups (int, optional): number of blocked connections from input channels to output channels.
</span></span></span><span class=line><span class=cl><span class=s2>                                    It allows depthwise convolution. When used, the input and output types need to be
</span></span></span><span class=line><span class=cl><span class=s2>                                    divisible in ``groups`` groups, all equal to each other.
</span></span></span><span class=line><span class=cl><span class=s2>                                    Default: ``1``.
</span></span></span><span class=line><span class=cl><span class=s2>            bias (bool, optional): Whether to add a bias to the output (only to fields which contain a
</span></span></span><span class=line><span class=cl><span class=s2>                    trivial irrep) or not. Default ``True``
</span></span></span><span class=line><span class=cl><span class=s2>            basisexpansion (str, optional): the basis expansion algorithm to use
</span></span></span><span class=line><span class=cl><span class=s2>            sigma (list or float, optional): width of each ring where the bases are sampled. If only one scalar
</span></span></span><span class=line><span class=cl><span class=s2>                    is passed, it is used for all rings.
</span></span></span><span class=line><span class=cl><span class=s2>            frequencies_cutoff (callable or float, optional): function mapping the radii of the basis elements to the
</span></span></span><span class=line><span class=cl><span class=s2>                    maximum frequency accepted. If a float values is passed, the maximum frequency is equal to the
</span></span></span><span class=line><span class=cl><span class=s2>                    radius times this factor. By default (``None``), a more complex policy is used.
</span></span></span><span class=line><span class=cl><span class=s2>            rings (list, optional): radii of the rings where to sample the bases
</span></span></span><span class=line><span class=cl><span class=s2>            maximum_offset (int, optional): number of additional (aliased) frequencies in the intertwiners for finite
</span></span></span><span class=line><span class=cl><span class=s2>                    groups. By default (``None``), all additional frequencies allowed by the frequencies cut-off
</span></span></span><span class=line><span class=cl><span class=s2>                    are used.
</span></span></span><span class=line><span class=cl><span class=s2>            recompute (bool, optional): if ``True``, recomputes a new basis for the equivariant kernels.
</span></span></span><span class=line><span class=cl><span class=s2>                    By Default (``False``), it  caches the basis built or reuse a cached one, if it is found.
</span></span></span><span class=line><span class=cl><span class=s2>            basis_filter (callable, optional): function which takes as input a descriptor of a basis element
</span></span></span><span class=line><span class=cl><span class=s2>                    (as a dictionary) and returns a boolean value: whether to preserve (``True``) or discard (``False``)
</span></span></span><span class=line><span class=cl><span class=s2>                    the basis element. By default (``None``), no filtering is applied.
</span></span></span><span class=line><span class=cl><span class=s2>            initialize (bool, optional): initialize the weights of the model. Default: ``True``
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Attributes:
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>            ~.weights (torch.Tensor): the learnable parameters which are used to expand the kernel
</span></span></span><span class=line><span class=cl><span class=s2>            ~.filter (torch.Tensor): the convolutional kernel obtained by expanding the parameters
</span></span></span><span class=line><span class=cl><span class=s2>                                    in :attr:`~e2cnn.nn.R2Conv.weights`
</span></span></span><span class=line><span class=cl><span class=s2>            ~.bias (torch.Tensor): the learnable parameters which are used to expand the bias, if ``bias=True``
</span></span></span><span class=line><span class=cl><span class=s2>            ~.expanded_bias (torch.Tensor): the equivariant bias which is summed to the output, obtained by expanding
</span></span></span><span class=line><span class=cl><span class=s2>                                    the parameters in :attr:`~e2cnn.nn.R2Conv.bias`
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># è¾“å…¥ç±»å‹å’Œè¾“å‡ºç±»å‹å¿…é¡»æ˜¯ä¸€ä¸ªç¾¤</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>in_type</span><span class=o>.</span><span class=n>gspace</span> <span class=o>==</span> <span class=n>out_type</span><span class=o>.</span><span class=n>gspace</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>in_type</span><span class=o>.</span><span class=n>gspace</span><span class=p>,</span> <span class=n>GeneralOnR2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># åˆå§‹åŒ–å¯¹åº”çš„å†…å®¹</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>R2Conv</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>space</span> <span class=o>=</span> <span class=n>in_type</span><span class=o>.</span><span class=n>gspace</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>in_type</span> <span class=o>=</span> <span class=n>in_type</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>out_type</span> <span class=o>=</span> <span class=n>out_type</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>kernel_size</span> <span class=o>=</span> <span class=n>kernel_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>stride</span> <span class=o>=</span> <span class=n>stride</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dilation</span> <span class=o>=</span> <span class=n>dilation</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>padding</span> <span class=o>=</span> <span class=n>padding</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>padding_mode</span> <span class=o>=</span> <span class=n>padding_mode</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>groups</span> <span class=o>=</span> <span class=n>groups</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># æ£€æŸ¥æ˜¯paddingæ˜¯å¦æ˜¯å…ƒç»„</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>padding</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>padding</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>_padding</span> <span class=o>=</span> <span class=n>padding</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ£€æŸ¥paddingæ˜¯å¦æ˜¯intï¼Œæ˜¯intåˆ™ç›´æ¥å°†å¯¹åº”çš„å†…å®¹ç›´æ¥è¿›è¡Œèµ‹å€¼</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>padding</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>_padding</span> <span class=o>=</span> <span class=p>(</span><span class=n>padding</span><span class=p>,</span> <span class=n>padding</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;padding needs to be either an integer or a tuple containing two integers but </span><span class=si>{}</span><span class=s1> found&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>padding</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>padding_modes</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;zeros&#39;</span><span class=p>,</span> <span class=s1>&#39;reflect&#39;</span><span class=p>,</span> <span class=s1>&#39;replicate&#39;</span><span class=p>,</span> <span class=s1>&#39;circular&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>padding_mode</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>padding_modes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;padding_mode must be one of [</span><span class=si>{}</span><span class=s2>], but got padding_mode=&#39;</span><span class=si>{}</span><span class=s2>&#39;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>padding_modes</span><span class=p>,</span> <span class=n>padding_mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_reversed_padding_repeated_twice</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>_padding</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># æ£€æŸ¥è¾“å…¥å’Œè¾“å‡ºç±»å¯ä»¥åˆ†ä¸ºâ€œgroupsâ€ç»„ï¼Œæ‰€æœ‰ç»„éƒ½å½¼æ­¤ç›¸ç­‰</span>
</span></span><span class=line><span class=cl>        <span class=c1># TODO: ææ‡‚è¿™ä¸ªå˜é‡çš„ä½œç”¨</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>groups</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Check the input and output classes can be split in `groups` groups, all equal to each other</span>
</span></span><span class=line><span class=cl>            <span class=c1># first, check that the number of fields is divisible by `groups`</span>
</span></span><span class=line><span class=cl>            <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>in_type</span><span class=p>)</span> <span class=o>%</span> <span class=n>groups</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>out_type</span><span class=p>)</span> <span class=o>%</span> <span class=n>groups</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>in_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>in_type</span><span class=p>)</span> <span class=o>//</span> <span class=n>groups</span>
</span></span><span class=line><span class=cl>            <span class=n>out_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>out_type</span><span class=p>)</span> <span class=o>//</span> <span class=n>groups</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># then, check that all groups are equal to each other, i.e. have the same types in the same order</span>
</span></span><span class=line><span class=cl>            <span class=k>assert</span> <span class=nb>all</span><span class=p>(</span><span class=n>in_type</span><span class=o>.</span><span class=n>representations</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>in_type</span><span class=o>.</span><span class=n>representations</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=n>in_size</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>in_type</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=k>assert</span> <span class=nb>all</span><span class=p>(</span><span class=n>out_type</span><span class=o>.</span><span class=n>representations</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>out_type</span><span class=o>.</span><span class=n>representations</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=n>out_size</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>out_type</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># finally, retrieve the type associated to a single group in input.</span>
</span></span><span class=line><span class=cl>            <span class=c1># this type will be used to build a smaller kernel basis and a smaller filter</span>
</span></span><span class=line><span class=cl>            <span class=c1># as in PyTorch, to build a filter for grouped convolution, we build a filter which maps from one input</span>
</span></span><span class=line><span class=cl>            <span class=c1># group to all output groups. Then, PyTorch&#39;s standard convolution routine interpret this filter as `groups`</span>
</span></span><span class=line><span class=cl>            <span class=c1># different filters, each mapping an input group to an output group.</span>
</span></span><span class=line><span class=cl>            <span class=n>in_type</span> <span class=o>=</span> <span class=n>in_type</span><span class=o>.</span><span class=n>index_select</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>in_size</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># è¿™æ®µä»£ç æ£€æŸ¥`bias`æ˜¯å¦ä¸ºçœŸå€¼ã€‚å¦‚æœ`bias`ä¸ºé•‡ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>bias</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># bias can be applied only to trivial irreps inside the representation</span>
</span></span><span class=line><span class=cl>            <span class=c1># to apply bias to a field we learn a bias for each trivial irreps it contains</span>
</span></span><span class=line><span class=cl>            <span class=c1># and, then, we transform it with the change of basis matrix to be able to apply it to the whole field</span>
</span></span><span class=line><span class=cl>            <span class=c1># this is equivalent to transform the field to its irreps through the inverse change of basis,</span>
</span></span><span class=line><span class=cl>            <span class=c1># sum the bias only to the trivial irrep and then map it back with the change of basis</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># count the number of trivial irreps</span>
</span></span><span class=line><span class=cl>            <span class=c1># è®¡ç®—å…·æœ‰å¹³å‡¡è¡¨ç¤ºçš„æ•°é‡</span>
</span></span><span class=line><span class=cl>            <span class=n>trivials</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=c1># éå†out_typeä¸­æ¯ä¸ªå…ƒç´ r</span>
</span></span><span class=line><span class=cl>            <span class=c1># å¯¹äº r ä¸­çš„æ¯ä¸ª irrï¼ˆè¡¨ç¤ºï¼‰ï¼Œæ£€æŸ¥ self.out_type.fibergroup.irreps[irr] æ˜¯å¦ä¸ºâ€œtrivialâ€ï¼ˆå¹³å‡¡çš„ï¼‰ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=c1># å¦‚æœæ˜¯ï¼Œåˆ™å°† trivials åŠ  1</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>out_type</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>irr</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>irreps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>out_type</span><span class=o>.</span><span class=n>fibergroup</span><span class=o>.</span><span class=n>irreps</span><span class=p>[</span><span class=n>irr</span><span class=p>]</span><span class=o>.</span><span class=n>is_trivial</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                        <span class=n>trivials</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># if there is at least 1 trivial irrep</span>
</span></span><span class=line><span class=cl>            <span class=c1># å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå¹³å‡¡è¡¨ç¤º</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>trivials</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># matrix containing the columns of the change of basis which map from the trivial irreps to the</span>
</span></span><span class=line><span class=cl>                <span class=c1># field representations. This matrix allows us to map the bias defined only over the trivial irreps</span>
</span></span><span class=line><span class=cl>                <span class=c1># to a bias for the whole field more efficiently</span>
</span></span><span class=line><span class=cl>                <span class=c1># åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º (self.out_type.size, trivials) çš„é›¶å¼ é‡ bias_expansionï¼Œç”¨äºå­˜å‚¨å˜æ¢çŸ©é˜µï¼Œè¯¥çŸ©é˜µèƒ½å¤Ÿå°†å¹³å‡¡è¡¨ç¤ºæ˜ å°„åˆ°å­—æ®µè¡¨ç¤ºä¸­ã€‚</span>
</span></span><span class=line><span class=cl>                <span class=n>bias_expansion</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>out_type</span><span class=o>.</span><span class=n>size</span><span class=p>,</span> <span class=n>trivials</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># é€šè¿‡å¾ªç¯éå† self.out_type ä¸­çš„æ¯ä¸ªå…ƒç´  rï¼Œå¹¶ä¸”å¯¹äº r ä¸­çš„æ¯ä¸ª irrï¼š</span>
</span></span><span class=line><span class=cl>                <span class=c1># æ£€æŸ¥ self.out_type.fibergroup.irreps[irr] æ˜¯å¦ä¸ºå¹³å‡¡è¡¨ç¤ºã€‚</span>
</span></span><span class=line><span class=cl>                <span class=c1># å¦‚æœæ˜¯å¹³å‡¡è¡¨ç¤ºï¼Œå°† r.change_of_basis[:, pi] èµ‹å€¼ç»™ bias_expansion çš„ç›¸åº”ä½ç½®ï¼Œå¹¶æ›´æ–°ç´¢å¼• cã€‚</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>,</span> <span class=n>c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>out_type</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>pi</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>irr</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>irreps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>irr</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>out_type</span><span class=o>.</span><span class=n>fibergroup</span><span class=o>.</span><span class=n>irreps</span><span class=p>[</span><span class=n>irr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>irr</span><span class=o>.</span><span class=n>is_trivial</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                            <span class=n>bias_expansion</span><span class=p>[</span><span class=n>p</span><span class=p>:</span><span class=n>p</span><span class=o>+</span><span class=n>r</span><span class=o>.</span><span class=n>size</span><span class=p>,</span> <span class=n>c</span><span class=p>]</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>change_of_basis</span><span class=p>[:,</span> <span class=n>pi</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                            <span class=n>c</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                        <span class=n>pi</span> <span class=o>+=</span> <span class=n>irr</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>                    <span class=n>p</span> <span class=o>+=</span> <span class=n>r</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># æ³¨å†Œå±æ€§ bias_expansion ä¸ºç±»çš„ç¼“å†²åŒºï¼ˆbufferï¼‰å±æ€§ï¼Œè¡¨ç¤ºæ­¤å±æ€§çš„å€¼ä¸éœ€è¦è¿›è¡Œæ¢¯åº¦è®¡ç®—ã€‚</span>
</span></span><span class=line><span class=cl>                <span class=c1># åˆ›å»ºå‚æ•° self.biasï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸º trivials çš„å¼ é‡ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºéœ€è¦æ¢¯åº¦è®¡ç®—ã€‚</span>
</span></span><span class=line><span class=cl>                <span class=c1># æ³¨å†Œå±æ€§ expanded_bias ä¸ºç±»çš„ç¼“å†²åŒºï¼ˆbufferï¼‰å±æ€§ï¼Œè¡¨ç¤ºæ­¤å±æ€§çš„å€¼ä¸éœ€è¦è¿›è¡Œæ¢¯åº¦è®¡ç®—ï¼Œå¹¶åˆå§‹åŒ–ä¸ºå¤§å°ä¸º out_type.size çš„é›¶å¼ é‡ã€‚</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>register_buffer</span><span class=p>(</span><span class=s2>&#34;bias_expansion&#34;</span><span class=p>,</span> <span class=n>bias_expansion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>bias</span> <span class=o>=</span> <span class=n>Parameter</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>trivials</span><span class=p>),</span> <span class=n>requires_grad</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>register_buffer</span><span class=p>(</span><span class=s2>&#34;expanded_bias&#34;</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>out_type</span><span class=o>.</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>bias</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>expanded_bias</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>bias</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>expanded_bias</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># compute the parameters of the basis</span>
</span></span><span class=line><span class=cl>        <span class=n>grid</span><span class=p>,</span> <span class=n>basis_filter</span><span class=p>,</span> <span class=n>rings</span><span class=p>,</span> <span class=n>sigma</span><span class=p>,</span> <span class=n>maximum_frequency</span> <span class=o>=</span> <span class=n>compute_basis_params</span><span class=p>(</span><span class=n>kernel_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                                                   <span class=n>frequencies_cutoff</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                                                   <span class=n>rings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                                                   <span class=n>sigma</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                                                   <span class=n>dilation</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                                                   <span class=n>basis_filter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># BasisExpansion: submodule which takes care of building the filter</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_basisexpansion</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># notice that `in_type` is used instead of `self.in_type` such that it works also when `groups &gt; 1`</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>basisexpansion</span> <span class=o>==</span> <span class=s1>&#39;blocks&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è¿™é‡Œæ˜¯æ•´ä¸ªæ ¸å¿ƒ</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_basisexpansion</span> <span class=o>=</span> <span class=n>BlocksBasisExpansion</span><span class=p>(</span><span class=n>in_type</span><span class=p>,</span> <span class=n>out_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                        <span class=n>basis_generator</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>space</span><span class=o>.</span><span class=n>build_kernel_basis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                        <span class=n>points</span><span class=o>=</span><span class=n>grid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                        <span class=n>sigma</span><span class=o>=</span><span class=n>sigma</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                        <span class=n>rings</span><span class=o>=</span><span class=n>rings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                        <span class=n>maximum_offset</span><span class=o>=</span><span class=n>maximum_offset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                        <span class=n>maximum_frequency</span><span class=o>=</span><span class=n>maximum_frequency</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                        <span class=n>basis_filter</span><span class=o>=</span><span class=n>basis_filter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                        <span class=n>recompute</span><span class=o>=</span><span class=n>recompute</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;Basis Expansion algorithm &#34;</span><span class=si>%s</span><span class=s1>&#34; not recognized&#39;</span> <span class=o>%</span> <span class=n>basisexpansion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>basisexpansion</span><span class=o>.</span><span class=n>dimension</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>                The basis for the steerable filter is empty!
</span></span></span><span class=line><span class=cl><span class=s1>                Tune the `frequencies_cutoff`, `kernel_size`, `rings`, `sigma` or `basis_filter` parameters to allow
</span></span></span><span class=line><span class=cl><span class=s1>                for a larger basis.
</span></span></span><span class=line><span class=cl><span class=s1>            &#39;&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>weights</span> <span class=o>=</span> <span class=n>Parameter</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>basisexpansion</span><span class=o>.</span><span class=n>dimension</span><span class=p>()),</span> <span class=n>requires_grad</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>register_buffer</span><span class=p>(</span><span class=s2>&#34;filter&#34;</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>out_type</span><span class=o>.</span><span class=n>size</span><span class=p>,</span> <span class=n>in_type</span><span class=o>.</span><span class=n>size</span><span class=p>,</span> <span class=n>kernel_size</span><span class=p>,</span> <span class=n>kernel_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>initialize</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># by default, the weights are initialized with a generalized form of He&#39;s weight initialization</span>
</span></span><span class=line><span class=cl>            <span class=n>init</span><span class=o>.</span><span class=n>generalized_he_init</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>weights</span><span class=o>.</span><span class=n>data</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>basisexpansion</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªå‡½æ•°ä¸ç®—çŸ­ï¼Œå’±ä»¬è¿˜æ˜¯è€è§„çŸ©ï¼Œä¸€å¥ä¸€å¥çœ‹ã€‚</p><p>å¯¹åº”çš„åˆå§‹åŒ–å’±ä»¬è¿™å°±ä¸çœ‹äº†ï¼Œç›´æ¥çœ‹å¯¹åº”ä»£ç æˆ‘å†™çš„æ³¨é‡Šå§ã€‚</p><p><code>if groups > 1</code>ï¼šè¿™é‡Œçš„groupä»£è¡¨æ˜¯è¾“å…¥é€šé“åˆ°è¾“å‡ºé€šé“çš„é˜»å¡è¿æ¥æ•°ï¼Œåœ¨è¿™é‡Œå…è®¸ æ·±åº¦å·ç§¯ï¼Œä½¿ç”¨æ—¶ï¼Œè¾“å…¥å’Œè¾“å‡ºç±»å‹éœ€è¦å¯åˆ†ä¸º<code>groups</code>ç»„ï¼Œå¹¶ä¸”å½¼æ­¤ç›¸ç­‰ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé»˜è®¤æ˜¯1ï¼Œå› æ­¤åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æš‚æ—¶ä¸è€ƒè™‘å¯¹åº”çš„å†…å®¹ã€‚è¿™ä¸ª ifåˆ†æ”¯æš‚æ—¶è·³è¿‡ã€‚</p><p><code>if bias:</code> è¿™ä¸ªåˆ†æ”¯åœ¨ä»£ç ä¸­è§£é‡Šçš„æ¯”è¾ƒæ¸…æ¥š ï¼Œç›´æ¥çœ‹å¯¹åº”çš„ä»£ç å°±å¥½ã€‚</p><p><code>grid, basis_filter, rings, sigma, maximum_frequency = compute_basis_params(kernel_size,frequencies_cutoff,rings,sigma,dilation,basis_filter)</code>ï¼šè¿™ä¸ªå‡½æ•° çš„ä½œç”¨æ˜¯è®¡ç®—basisçš„å˜é‡ã€‚ç„¶åçœ‹è¿™ä¸ªå‡½æ•°ä¸­çš„ç»†èŠ‚ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>compute_basis_params</span><span class=p>(</span><span class=n>kernel_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>frequencies_cutoff</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=n>Callable</span><span class=p>[[</span><span class=nb>float</span><span class=p>],</span> <span class=nb>float</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>rings</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>sigma</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>dilation</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>custom_basis_filter</span><span class=p>:</span> <span class=n>Callable</span><span class=p>[[</span><span class=nb>dict</span><span class=p>],</span> <span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># compute the coordinates of the centers of the cells in the grid where the filter is sampled</span>
</span></span><span class=line><span class=cl>    <span class=c1># è®¡ç®—å¯¹æ»¤æ³¢å™¨è¿›è¡Œé‡‡æ ·çš„ç½‘æ ¼ä¸­å•å…ƒæ ¼ä¸­å¿ƒçš„åæ ‡</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span> <span class=o>=</span> <span class=n>get_grid_coords</span><span class=p>(</span><span class=n>kernel_size</span><span class=p>,</span> <span class=n>dilation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è®¡ç®—æ»¤æ³¢å™¨çš„æœ€å¤§åŠå¾„</span>
</span></span><span class=line><span class=cl>    <span class=n>max_radius</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>((</span><span class=n>grid</span> <span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span><span class=o>.</span><span class=n>max</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># max_radius = kernel_size // 2</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># by default, the number of rings equals half of the filter size</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>rings</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>n_rings</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>ceil</span><span class=p>(</span><span class=n>kernel_size</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># if self.group.order() &gt; 0:</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     # compute the number of edges of the polygon inscribed in the filter (which is a square)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     # whose points stay inside the filter under the action of the group</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     # the number of edges is lcm(group&#39;s order, 4)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     n_edges = self.group.order()</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     while n_edges % 4 &gt; 0:</span>
</span></span><span class=line><span class=cl>        <span class=c1>#         n_edges *= 2</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     # the largest ring we can sample has radius equal to the circumradius of the polygon described above</span>
</span></span><span class=line><span class=cl>        <span class=c1>#     n_rings /= math.cos(math.pi/n_edges)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># n_rings = s // 2 + 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># torch.linspace(start, end, steps) æ˜¯ä¸€ä¸ª PyTorch å‡½æ•°ï¼Œå®ƒç”Ÿæˆä¸€ä¸ªåŒ…å«åœ¨æŒ‡å®šèŒƒå›´å†…ã€åŒ…æ‹¬èµ·å§‹å€¼å’Œç»“æŸå€¼çš„å‡åŒ€é—´éš”çš„ä¸€ç»´å¼ é‡ï¼ˆTensorï¼‰ï¼Œæ­¤å¤„ç”¨äºç”Ÿæˆç¯çš„åŠå¾„ï¼ˆringsï¼‰ã€‚</span>
</span></span><span class=line><span class=cl>        <span class=c1># start æ˜¯èµ·å§‹å€¼ï¼Œè¿™é‡Œä¸º0ï¼Œè¡¨ç¤ºå¼ é‡ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„å€¼ã€‚</span>
</span></span><span class=line><span class=cl>        <span class=c1># end æ˜¯ç»“æŸå€¼ï¼Œå³(kernel_size - 1) // 2ï¼Œè¿™ä¸ªå€¼æ˜¯ç”±å·ç§¯æ ¸å¤§å°å‡å»1ï¼Œç„¶åæ•´é™¤2å¾—åˆ°çš„ã€‚è¿™ä¸ªå€¼å†³å®šäº†å¼ é‡ä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„å€¼ã€‚</span>
</span></span><span class=line><span class=cl>        <span class=c1># n_rings æ˜¯ç”Ÿæˆçš„å¼ é‡ä¸­å…ƒç´ çš„æ•°é‡ï¼Œå³ç”Ÿæˆçš„ç¯æ•°ç›®ã€‚</span>
</span></span><span class=line><span class=cl>        <span class=c1># dilation å°†æ•´ä¸ªç”Ÿæˆçš„å¼ é‡å…ƒç´ ä¹˜ä»¥ dilationã€‚è¿™ä¸ªæ­¥éª¤å°†æŒ‰ç…§ dilation çš„å€æ•°æ¥è°ƒæ•´ç”Ÿæˆçš„ç¯çš„åŠå¾„å€¼ã€‚</span>
</span></span><span class=line><span class=cl>        <span class=c1># rings = torch.linspace(1 - s % 2, s // 2, n_rings)</span>
</span></span><span class=line><span class=cl>        <span class=n>rings</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=n>kernel_size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span><span class=p>,</span> <span class=n>n_rings</span><span class=p>)</span> <span class=o>*</span> <span class=n>dilation</span>
</span></span><span class=line><span class=cl>        <span class=n>rings</span> <span class=o>=</span> <span class=n>rings</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>all</span><span class=p>([</span><span class=n>max_radius</span> <span class=o>&gt;=</span> <span class=n>r</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>rings</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>sigma</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sigma</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.6</span><span class=p>]</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rings</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=p>[</span><span class=mf>0.4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>r</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>rings</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>r</span> <span class=o>==</span> <span class=mf>0.</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>sigma</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.005</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>sigma</span><span class=p>,</span> <span class=nb>float</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>sigma</span> <span class=o>=</span> <span class=p>[</span><span class=n>sigma</span><span class=p>]</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>rings</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=c1># TODO - use a string name for this setting</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>frequencies_cutoff</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>frequencies_cutoff</span> <span class=o>=</span> <span class=o>-</span><span class=mf>1.</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>frequencies_cutoff</span><span class=p>,</span> <span class=nb>float</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>frequencies_cutoff</span> <span class=o>==</span> <span class=o>-</span><span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>frequencies_cutoff</span> <span class=o>=</span> <span class=n>_manual_fco3</span><span class=p>(</span><span class=n>kernel_size</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>frequencies_cutoff</span> <span class=o>==</span> <span class=o>-</span><span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>frequencies_cutoff</span> <span class=o>=</span> <span class=n>_manual_fco2</span><span class=p>(</span><span class=n>kernel_size</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>frequencies_cutoff</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>frequencies_cutoff</span> <span class=o>=</span> <span class=n>_manual_fco1</span><span class=p>(</span><span class=n>kernel_size</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>frequencies_cutoff</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>r</span><span class=p>,</span> <span class=n>fco</span><span class=o>=</span><span class=n>frequencies_cutoff</span><span class=p>:</span> <span class=n>fco</span> <span class=o>*</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># check if the object is a callable function</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>callable</span><span class=p>(</span><span class=n>frequencies_cutoff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>maximum_frequency</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=nb>max</span><span class=p>(</span><span class=n>frequencies_cutoff</span><span class=p>(</span><span class=n>r</span><span class=p>)</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>rings</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fco_filter</span> <span class=o>=</span> <span class=n>bandlimiting_filter</span><span class=p>(</span><span class=n>frequencies_cutoff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>custom_basis_filter</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>basis_filter</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>d</span><span class=p>,</span> <span class=n>custom_basis_filter</span><span class=o>=</span><span class=n>custom_basis_filter</span><span class=p>,</span> <span class=n>fco_filter</span><span class=o>=</span><span class=n>fco_filter</span><span class=p>:</span> <span class=p>(</span><span class=n>custom_basis_filter</span><span class=p>(</span><span class=n>d</span><span class=p>)</span> <span class=ow>and</span> <span class=n>fco_filter</span><span class=p>(</span><span class=n>d</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>basis_filter</span> <span class=o>=</span> <span class=n>fco_filter</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>grid</span><span class=p>,</span> <span class=n>basis_filter</span><span class=p>,</span> <span class=n>rings</span><span class=p>,</span> <span class=n>sigma</span><span class=p>,</span> <span class=n>maximum_frequency</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªä»£ç ä¹Ÿæ˜¯ ä¸€ä¸ªç¨å¾®é•¿ç‚¹çš„ä»£ç ï¼Œokï¼Œå’±ä»¬è¿˜æ˜¯ä¸€è¡Œä¸€è¡Œçœ‹ã€‚</p><p><code>grid = get_grid_coords(kernel_size, dilation)</code>è¿™ä¸ªå‡½æ•°è®¡ç®—æ»¤æ³¢å™¨é‡‡æ ·ç½‘æ ¼ä¸­å•å…ƒä¸­å¿ƒçš„åæ ‡ï¼Œé¦–å…ˆå…ˆçœ‹ è¿™ä¸ªå‡½æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_grid_coords</span><span class=p>(</span><span class=n>kernel_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>dilation</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¿™é‡Œé¢å°±æ˜¯åœ¨é‚£ä¸ªç”µç§‘å¤§çš„ç¡•å£«è®ºæ–‡ä¸­å†™çš„ä¸œè¥¿ï¼Œæ ¹æ®å·ç§¯æ ¸çš„å¤§å°ä¸è½¬æ¢å‡½æ•°çš„å¾—åˆ°å¯¹åº”çš„æ ‡å¿—çŸ©é˜µ</span>
</span></span><span class=line><span class=cl>    <span class=n>actual_size</span> <span class=o>=</span> <span class=n>dilation</span> <span class=o>*</span> <span class=p>(</span><span class=n>kernel_size</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>origin</span> <span class=o>=</span> <span class=n>actual_size</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>-</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>points</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>kernel_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>*=</span> <span class=n>dilation</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>kernel_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>*=</span> <span class=n>dilation</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>origin</span><span class=p>,</span> <span class=o>-</span><span class=n>y</span> <span class=o>+</span> <span class=n>origin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>points</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>points</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>points</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>points</span><span class=o>.</span><span class=n>shape</span> <span class=o>==</span> <span class=p>(</span><span class=n>kernel_size</span> <span class=o>**</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=n>points</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>points</span><span class=o>.</span><span class=n>T</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªå†…å®¹å…¶å®å¾ˆæ¸…æ¥šï¼Œå°±æ˜¯æ ¹æ®å·ç§¯æ ¸çš„å¤§å°ä»¥åŠè½¬æ¢å‡½æ•°ç”Ÿæˆå¯¹åº”çš„è½¬æ¢çŸ©é˜µã€‚å…·ä½“å†…å®¹å¯ä»¥çœ‹ç”µç§‘å¤§çš„ç¡•å£«è®ºæ–‡ä¸­å¯¹äºè¿™ä¸ªè¿‡ç¨‹çš„æè¿°ï¼Œè¿™é‡Œæˆªä¸ªå›¾ã€‚</p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312042102612.png loading=lazy></p><p>ç„¶åæˆ‘ä»¬çœ‹ä¸‹é¢çš„ä»£ç ï¼š<code>max_radius = np.sqrt((grid **2).sum(0)).max()</code>è®¡ç®—å¯¹åº”æ»¤æ³¢å™¨çš„æœ€å¤§åŠå¾„ã€‚</p><p><code>if rings is None:n_rings = math.ceil(kernel_size / 2)</code>è¿™ä¸ªçš„è¯å¦‚æœringsè¿™ä¸ªå˜é‡ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥æŒ‡å®šä¸ºå·ç§¯æ ¸å¤§å°çš„ä¸€åŠã€‚</p><p><code>rings = torch.linspace(0, (kernel_size - 1) // 2, n_rings) * dilation</code>:Torch.linspace(start, end, steps) æ˜¯ä¸€ä¸ª PyTorch å‡½æ•°ï¼Œå®ƒç”Ÿæˆä¸€ä¸ªåŒ…å«åœ¨æŒ‡å®šèŒƒå›´å†…ã€åŒ…æ‹¬èµ·å§‹å€¼å’Œç»“æŸå€¼çš„å‡åŒ€é—´éš”çš„ä¸€ç»´å¼ é‡ï¼ˆTensorï¼‰ï¼Œæ­¤å¤„ç”¨äºç”Ÿæˆç¯çš„åŠå¾„ï¼ˆringsï¼‰ã€‚start æ˜¯èµ·å§‹å€¼ï¼Œè¿™é‡Œä¸º0ï¼Œè¡¨ç¤ºå¼ é‡ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„å€¼ã€‚end æ˜¯ç»“æŸå€¼ï¼Œå³(kernel_size - 1) // 2ï¼Œè¿™ä¸ªå€¼æ˜¯ç”±å·ç§¯æ ¸å¤§å°å‡å»1ï¼Œç„¶åæ•´é™¤2å¾—åˆ°çš„ã€‚è¿™ä¸ªå€¼å†³å®šäº†å¼ é‡ä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„å€¼ã€‚n_rings æ˜¯ç”Ÿæˆçš„å¼ é‡ä¸­å…ƒç´ çš„æ•°é‡ï¼Œå³ç”Ÿæˆçš„ç¯æ•°ç›®ã€‚dilation å°†æ•´ä¸ªç”Ÿæˆçš„å¼ é‡å…ƒç´ ä¹˜ä»¥ dilationã€‚è¿™ä¸ªæ­¥éª¤å°†æŒ‰ç…§ dilation çš„å€æ•°æ¥è°ƒæ•´ç”Ÿæˆçš„ç¯çš„åŠå¾„å€¼ã€‚</p><p><code>rings = rings.tolist()</code>è½¬æ¢æˆå¯¹åº”çš„åˆ—è¡¨ã€‚</p><p>è¿™é‡Œçš„è¯å…¶å®å°±æ˜¯è®¾ç½®ä¸€ä¸ªå˜é‡ï¼Œç„¶åæ¥ç€å¾€ä¸‹é¢çœ‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>if</span> <span class=n>sigma</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sigma</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.6</span><span class=p>]</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rings</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=p>[</span><span class=mf>0.4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>r</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>rings</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r</span> <span class=o>==</span> <span class=mf>0.</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sigma</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mf>0.005</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„è¯è¿˜æ˜¯ç”Ÿæˆå¯¹åº”çš„sigmaå˜é‡ï¼Œæ ¹æ®ä¸Šé¢ ç”Ÿæˆringsï¼ŒæŒ‡å®šå…¶ä¸­sigmaè§’åº¦ã€‚</p><p>okï¼Œå†å¾€ä¸‹é¢å¾ˆé•¿ï¼Œä½†æ˜¯åœ¨æœ¬æ¬¡è¿è¡Œä¸­ï¼Œæœ‰å¾ˆå¤šæ²¡æœ‰èµ°åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥çœ‹è¿è¡Œæ—¶ä½¿ç”¨çš„å†…å®¹ï¼Œå‰©ä¸‹çš„ç­‰æœ‰æ—¶é—´å†å»çœ‹å§ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>maximum_frequency</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=nb>max</span><span class=p>(</span><span class=n>frequencies_cutoff</span><span class=p>(</span><span class=n>r</span><span class=p>)</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>rings</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>fco_filter</span> <span class=o>=</span> <span class=n>bandlimiting_filter</span><span class=p>(</span><span class=n>frequencies_cutoff</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=n>basis_filter</span> <span class=o>=</span> <span class=n>fco_filter</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªçš„å°±æ˜¯å–å¾—ringsä¸­çš„æœ€å¤§å€¼ï¼Œç„¶åè¿›è¡Œè¿”å›ã€‚</p><p>ä¸‹é¢çš„å‡½æ•°ç”¨äºæ ¹æ®ç»™å®šçš„å±æ€§æ¥å†³å®šæ˜¯å¦ä¿ç•™åŸºç¡€å…ƒç´ ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿä¸æ˜¯å¾ˆé‡è¦ ï¼Œç”±äºæ—¶é—´æœ‰é™ï¼Œå…ˆä¸å†™ï¼Œæ ‡è®°ä¸€ä¸ªTODOã€‚</p><p>okï¼Œè¿™ä¸ª å‡½æ•°é˜¶æ•°ï¼Œç„¶åæ¥ç€å‘ä¸‹çœ‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>_basisexpansion</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=c1># notice that `in_type` is used instead of `self.in_type` such that it works also when `groups &gt; 1`</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>basisexpansion</span> <span class=o>==</span> <span class=s1>&#39;blocks&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># è¿™é‡Œæ˜¯æ•´ä¸ªæ ¸å¿ƒ</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>_basisexpansion</span> <span class=o>=</span> <span class=n>BlocksBasisExpansion</span><span class=p>(</span><span class=n>in_type</span><span class=p>,</span> <span class=n>out_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>basis_generator</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>space</span><span class=o>.</span><span class=n>build_kernel_basis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>points</span><span class=o>=</span><span class=n>grid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>sigma</span><span class=o>=</span><span class=n>sigma</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>rings</span><span class=o>=</span><span class=n>rings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>maximum_offset</span><span class=o>=</span><span class=n>maximum_offset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>maximum_frequency</span><span class=o>=</span><span class=n>maximum_frequency</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>basis_filter</span><span class=o>=</span><span class=n>basis_filter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>recompute</span><span class=o>=</span><span class=n>recompute</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨æˆ‘ä»¬ç”Ÿæˆäº†å¯¹åº” çš„å†…å®¹ä¹‹åï¼Œä¸‹é¢<code>BlocksBasisExpansion</code>å°±æ˜¯æ•´ä¸ªå‡½æ•°çš„æ ¸å¿ƒï¼Œæ•´ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å·ç§¯æ ¸çš„è®¾ç½®ã€‚okï¼Œä¸‹é¢çœ‹è¿™ä¸ªå‡½æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>BlocksBasisExpansion</span><span class=p>(</span><span class=n>BasisExpansion</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>in_type</span><span class=p>:</span> <span class=n>FieldType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>out_type</span><span class=p>:</span> <span class=n>FieldType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>basis_generator</span><span class=p>:</span> <span class=n>Callable</span><span class=p>[[</span><span class=n>Representation</span><span class=p>,</span> <span class=n>Representation</span><span class=p>],</span> <span class=n>Basis</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                 <span class=n>points</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>basis_filter</span><span class=p>:</span> <span class=n>Callable</span><span class=p>[[</span><span class=nb>dict</span><span class=p>],</span> <span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>recompute</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=o>**</span><span class=n>kwargs</span>
</span></span><span class=line><span class=cl>                 <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=sa>r</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        With this algorithm, the expansion is done on the intertwiners of the fields&#39; representations pairs in input and
</span></span></span><span class=line><span class=cl><span class=s2>        output.
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            in_type (FieldType): the input field type
</span></span></span><span class=line><span class=cl><span class=s2>            out_type (FieldType): the output field type
</span></span></span><span class=line><span class=cl><span class=s2>            basis_generator (callable): method that generates the analytical filter basis
</span></span></span><span class=line><span class=cl><span class=s2>            points (~numpy.ndarray): points where the analytical basis should be sampled
</span></span></span><span class=line><span class=cl><span class=s2>            basis_filter (callable, optional): filter for the basis elements. Should take a dictionary containing an
</span></span></span><span class=line><span class=cl><span class=s2>                                               element&#39;s attributes and return whether to keep it or not.
</span></span></span><span class=line><span class=cl><span class=s2>            recompute (bool, optional): whether to recompute new bases or reuse, if possible, already built tensors.
</span></span></span><span class=line><span class=cl><span class=s2>            **kwargs: keyword arguments to be passed to ```basis_generator```
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        Attributes:
</span></span></span><span class=line><span class=cl><span class=s2>            S (int): number of points where the filters are sampled
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>in_type</span><span class=o>.</span><span class=n>gspace</span> <span class=o>==</span> <span class=n>out_type</span><span class=o>.</span><span class=n>gspace</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>in_type</span><span class=o>.</span><span class=n>gspace</span><span class=p>,</span> <span class=n>GeneralOnR2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>BlocksBasisExpansion</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_in_type</span> <span class=o>=</span> <span class=n>in_type</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_out_type</span> <span class=o>=</span> <span class=n>out_type</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_input_size</span> <span class=o>=</span> <span class=n>in_type</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_output_size</span> <span class=o>=</span> <span class=n>out_type</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>points</span> <span class=o>=</span> <span class=n>points</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># int: number of points where the filters are sampled</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>S</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>points</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># we group the basis vectors by their input and output representations</span>
</span></span><span class=line><span class=cl>        <span class=n>_block_expansion_modules</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># iterate through all different pairs of input/output representationions</span>
</span></span><span class=line><span class=cl>        <span class=c1># and, for each of them, build a basis</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i_repr</span> <span class=ow>in</span> <span class=n>in_type</span><span class=o>.</span><span class=n>_unique_representations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>o_repr</span> <span class=ow>in</span> <span class=n>out_type</span><span class=o>.</span><span class=n>_unique_representations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>reprs_names</span> <span class=o>=</span> <span class=p>(</span><span class=n>i_repr</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>o_repr</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>basis</span> <span class=o>=</span> <span class=n>basis_generator</span><span class=p>(</span><span class=n>i_repr</span><span class=p>,</span> <span class=n>o_repr</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=n>block_expansion</span> <span class=o>=</span> <span class=n>block_basisexpansion</span><span class=p>(</span><span class=n>basis</span><span class=p>,</span> <span class=n>points</span><span class=p>,</span> <span class=n>basis_filter</span><span class=p>,</span> <span class=n>recompute</span><span class=o>=</span><span class=n>recompute</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>_block_expansion_modules</span><span class=p>[</span><span class=n>reprs_names</span><span class=p>]</span> <span class=o>=</span> <span class=n>block_expansion</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=c1># register the block expansion as a submodule</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>add_module</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;block_expansion_</span><span class=si>{</span><span class=n>reprs_names</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>block_expansion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=n>EmptyBasisException</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># print(f&#34;Empty basis at {reprs_names}&#34;)</span>
</span></span><span class=line><span class=cl>                    <span class=k>pass</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_block_expansion_modules</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;WARNING! The basis for the block expansion of the filter is empty!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_n_pairs</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>in_type</span><span class=o>.</span><span class=n>_unique_representations</span><span class=p>)</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>out_type</span><span class=o>.</span><span class=n>_unique_representations</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># the list of all pairs of input/output representations which don&#39;t have an empty basis</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_representations_pairs</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>_block_expansion_modules</span><span class=o>.</span><span class=n>keys</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># retrieve for each representation in both input and output fields:</span>
</span></span><span class=line><span class=cl>        <span class=c1># - the number of its occurrences,</span>
</span></span><span class=line><span class=cl>        <span class=c1># - the indices where it occurs and</span>
</span></span><span class=line><span class=cl>        <span class=c1># - whether its occurrences are contiguous or not</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_in_count</span><span class=p>,</span> <span class=n>_in_indices</span><span class=p>,</span> <span class=n>_in_contiguous</span> <span class=o>=</span> <span class=n>_retrieve_indices</span><span class=p>(</span><span class=n>in_type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_out_count</span><span class=p>,</span> <span class=n>_out_indices</span><span class=p>,</span> <span class=n>_out_contiguous</span> <span class=o>=</span> <span class=n>_retrieve_indices</span><span class=p>(</span><span class=n>out_type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># compute the attributes and an id for each basis element (and, so, of each parameter)</span>
</span></span><span class=line><span class=cl>        <span class=c1># attributes, basis_ids = _compute_attrs_and_ids(in_type, out_type, _block_expansion_modules)</span>
</span></span><span class=line><span class=cl>        <span class=n>basis_ids</span> <span class=o>=</span> <span class=n>_compute_attrs_and_ids</span><span class=p>(</span><span class=n>in_type</span><span class=p>,</span> <span class=n>out_type</span><span class=p>,</span> <span class=n>_block_expansion_modules</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_weights_ranges</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>last_weight_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_ids_to_basis</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_basis_to_ids</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_contiguous</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># iterate through the different group of blocks</span>
</span></span><span class=line><span class=cl>        <span class=c1># i.e., through all input/output pairs</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>io_pair</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_representations_pairs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_contiguous</span><span class=p>[</span><span class=n>io_pair</span><span class=p>]</span> <span class=o>=</span> <span class=n>_in_contiguous</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span> <span class=ow>and</span> <span class=n>_out_contiguous</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>            <span class=c1># build the indices tensors</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_contiguous</span><span class=p>[</span><span class=n>io_pair</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=c1># in_indices = torch.LongTensor([</span>
</span></span><span class=line><span class=cl>                <span class=n>in_indices</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>_in_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>_in_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>_in_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>_in_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span><span class=c1># )</span>
</span></span><span class=line><span class=cl>                <span class=c1># out_indices = torch.LongTensor([</span>
</span></span><span class=line><span class=cl>                <span class=n>out_indices</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>_out_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>_out_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>_out_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>_out_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span> <span class=c1>#)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;in_indices_</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>io_pair</span><span class=p>),</span> <span class=n>in_indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;out_indices_</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>io_pair</span><span class=p>),</span> <span class=n>out_indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>out_indices</span><span class=p>,</span> <span class=n>in_indices</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>meshgrid</span><span class=p>([</span><span class=n>_out_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>1</span><span class=p>]],</span> <span class=n>_in_indices</span><span class=p>[</span><span class=n>io_pair</span><span class=p>[</span><span class=mi>0</span><span class=p>]]])</span>
</span></span><span class=line><span class=cl>                <span class=n>in_indices</span> <span class=o>=</span> <span class=n>in_indices</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>out_indices</span> <span class=o>=</span> <span class=n>out_indices</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># register the indices tensors and the bases tensors as parameters of this module</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>register_buffer</span><span class=p>(</span><span class=s1>&#39;in_indices_</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>io_pair</span><span class=p>),</span> <span class=n>in_indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>register_buffer</span><span class=p>(</span><span class=s1>&#39;out_indices_</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>io_pair</span><span class=p>),</span> <span class=n>out_indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=c1># count the actual number of parameters</span>
</span></span><span class=line><span class=cl>            <span class=n>total_weights</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>basis_ids</span><span class=p>[</span><span class=n>io_pair</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=nb>id</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>basis_ids</span><span class=p>[</span><span class=n>io_pair</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_ids_to_basis</span><span class=p>[</span><span class=nb>id</span><span class=p>]</span> <span class=o>=</span> <span class=n>last_weight_position</span> <span class=o>+</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_basis_to_ids</span> <span class=o>+=</span> <span class=n>basis_ids</span><span class=p>[</span><span class=n>io_pair</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># evaluate the indices in the global weights tensor to use for the basis belonging to this group</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_weights_ranges</span><span class=p>[</span><span class=n>io_pair</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>last_weight_position</span><span class=p>,</span> <span class=n>last_weight_position</span> <span class=o>+</span> <span class=n>total_weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>            <span class=c1># increment the position counter</span>
</span></span><span class=line><span class=cl>            <span class=n>last_weight_position</span> <span class=o>+=</span> <span class=n>total_weights</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªé•¿å‡½æ•°ï¼Œé¦–å…ˆä¹Ÿæ˜¯åˆå§‹åŒ–å˜é‡ï¼Œç„¶åç›´æ¥çœ‹è¿™ä¸ªç®—æ³•ä¸­å¯¹åº”çš„æ ¸å¿ƒï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl> <span class=k>for</span> <span class=n>i_repr</span> <span class=ow>in</span> <span class=n>in_type</span><span class=o>.</span><span class=n>_unique_representations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>o_repr</span> <span class=ow>in</span> <span class=n>out_type</span><span class=o>.</span><span class=n>_unique_representations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>reprs_names</span> <span class=o>=</span> <span class=p>(</span><span class=n>i_repr</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>o_repr</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>basis</span> <span class=o>=</span> <span class=n>basis_generator</span><span class=p>(</span><span class=n>i_repr</span><span class=p>,</span> <span class=n>o_repr</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>block_expansion</span> <span class=o>=</span> <span class=n>block_basisexpansion</span><span class=p>(</span><span class=n>basis</span><span class=p>,</span> <span class=n>points</span><span class=p>,</span> <span class=n>basis_filter</span><span class=p>,</span> <span class=n>recompute</span><span class=o>=</span><span class=n>recompute</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>_block_expansion_modules</span><span class=p>[</span><span class=n>reprs_names</span><span class=p>]</span> <span class=o>=</span> <span class=n>block_expansion</span>
</span></span></code></pre></td></tr></table></div></div><p>çœ‹è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œç›´æ¥çœ‹é‡Œé¢çš„å‡½æ•°å§ã€‚<code>block_basisexpansion</code>è¿™ä¸ªå‡½æ•°æ˜¯æœ¬æ–‡éœ€è¦é‡ç‚¹è®²è§£çš„å†…å®¹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>block_basisexpansion</span><span class=p>(</span><span class=n>basis</span><span class=p>:</span> <span class=n>Basis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>points</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>basis_filter</span><span class=p>:</span> <span class=n>Callable</span><span class=p>[[</span><span class=nb>dict</span><span class=p>],</span> <span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                         <span class=n>recompute</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                         <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>SingleBlockBasisExpansion</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=sa>r</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Return an instance of :class:`~e2cnn.nn.modules.r2_conv.SingleBlockBasisExpansion`.
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    This function support caching through the argument ``recompute``.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        basis (Basis): basis defining the space of kernels
</span></span></span><span class=line><span class=cl><span class=s2>        points (~np.ndarray): points where the analytical basis should be sampled
</span></span></span><span class=line><span class=cl><span class=s2>        basis_filter (callable, optional): filter for the basis elements. Should take a dictionary containing an
</span></span></span><span class=line><span class=cl><span class=s2>                                           element&#39;s attributes and return whether to keep it or not.
</span></span></span><span class=line><span class=cl><span class=s2>        recompute (bool, optional): whether to recompute new bases (``True``) or reuse, if possible,
</span></span></span><span class=line><span class=cl><span class=s2>                                    already built tensors (``False``, default).
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>recompute</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># compute the mask of the sampled basis containing only the elements allowed by the filter</span>
</span></span><span class=line><span class=cl>        <span class=n>mask</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>basis</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>b</span><span class=p>,</span> <span class=n>attr</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>basis</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>mask</span><span class=p>[</span><span class=n>b</span><span class=p>]</span> <span class=o>=</span> <span class=n>basis_filter</span><span class=p>(</span><span class=n>attr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=p>(</span><span class=n>basis</span><span class=p>,</span> <span class=n>mask</span><span class=o>.</span><span class=n>tobytes</span><span class=p>(),</span> <span class=n>points</span><span class=o>.</span><span class=n>tobytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>_stored_filters</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>_stored_filters</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>SingleBlockBasisExpansion</span><span class=p>(</span><span class=n>basis</span><span class=p>,</span> <span class=n>points</span><span class=p>,</span> <span class=n>basis_filter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>_stored_filters</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>SingleBlockBasisExpansion</span><span class=p>(</span><span class=n>basis</span><span class=p>,</span> <span class=n>points</span><span class=p>,</span> <span class=n>basis_filter</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>å’±ä»¬å‰é¢å·²ç»è®¡ç®—å¾—åˆ°å¯¹åº”çš„pointç­‰å†…å®¹ï¼Œè¿™äº›å†…å®¹éƒ½ä¼ è¿‡æ¥ï¼Œç”±äºrecomputeçš„å€¼æ—¶Falseï¼Œè¿™ä¸ªæ—¶å€™èµ°çš„æ˜¯elseåˆ†æ”¯ï¼Œä½¿ç”¨ çš„<code>SingleBlockBasisExpansion</code>å‡½æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>SingleBlockBasisExpansion</span><span class=p>(</span><span class=n>BasisExpansion</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl> 
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªå‡½æ•°æ˜¯å¯¹ç»™å®šåŸºç¡€çš„ä¸€éƒ¨åˆ†è¿›è¡Œé‡‡æ ·ï¼Œå¹¶è¿›è¡Œä¸€ç³»åˆ—å¤„ç†ï¼ˆè¿‡æ»¤ã€å½’ä¸€åŒ–ç­‰ï¼‰ï¼Œä»¥ä¾¿åœ¨æ¨¡å‹ä¸­ä½¿ç”¨ã€‚<code>basis</code> æ˜¯ä¸€ä¸ªä»£è¡¨åˆ†æåŸºå‡½æ•°çš„å¯¹è±¡ã€‚</p><ul><li><code>points</code> æ˜¯åŸºå‡½æ•°åº”è¯¥è¢«é‡‡æ ·çš„ç‚¹ã€‚</li><li><code>basis_filter</code> æ˜¯ä¸€ä¸ªå¯é€‰çš„å›è°ƒå‡½æ•°ï¼Œç”¨äºè¿‡æ»¤åŸºå‡½æ•°å…ƒç´ ã€‚å®ƒæ¥å—ä¸€ä¸ªåŒ…å«å…ƒç´ å±æ€§çš„å­—å…¸ï¼Œå¹¶è¿”å›æ˜¯å¦ä¿ç•™è¯¥å…ƒç´ ã€‚</li><li>åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆè°ƒç”¨çˆ¶ç±» <code>BasisExpansion</code> çš„æ„é€ å‡½æ•°ã€‚</li><li>æ¥ä¸‹æ¥ï¼ŒåŸºäº <code>basis_filter</code> è¿‡æ»¤åŸºå‡½æ•°ï¼Œå¹¶æå–å±æ€§ä¿¡æ¯ã€‚å¦‚æœè¿‡æ»¤åçš„åŸºå‡½æ•°ä¸ºç©ºï¼Œåˆ™å¼•å‘ <code>EmptyBasisException</code> å¼‚å¸¸ã€‚</li><li>è®¡ç®—åŸºå‡½æ•°å…ƒç´ çš„å®é™…è¾“å‡ºå¤§å°ï¼Œä»¥ä¾¿æ‰§è¡Œå½’ä¸€åŒ–æ“ä½œã€‚</li><li>åœ¨ç½‘æ ¼ä¸Šå¯¹åŸºå‡½æ•°è¿›è¡Œé‡‡æ ·ï¼Œå¹¶è¿‡æ»¤æ‰è¢«è¿‡æ»¤å™¨ä¸¢å¼ƒçš„åŸºå‡½æ•°å…ƒç´ ã€‚</li><li>ä½¿ç”¨ <code>torch.Tensor</code> åˆ›å»ºåŸºå‡½æ•°å¼ é‡ï¼Œå¹¶å¯¹å…¶è¿›è¡Œä¸€äº›å¤„ç†å’Œå½’ä¸€åŒ–æ“ä½œã€‚</li><li>ä¸¢å¼ƒå‡ ä¹å…¨ä¸ºé›¶çš„åŸºå‡½æ•°å…ƒç´ ã€‚</li><li>å°†æœ€ç»ˆçš„æ©ç ï¼ˆmaskï¼‰å­˜å‚¨ä¸ºç±»çš„ç§æœ‰å±æ€§ <code>_mask</code>ã€‚</li><li>å°†ç¬¦åˆæ¡ä»¶çš„å±æ€§ä¿¡æ¯å’Œé‡‡æ ·åçš„åŸºå‡½æ•°å¼ é‡ä½œä¸ºæ¨¡å—å‚æ•°è¿›è¡Œæ³¨å†Œã€‚</li></ul><p>ä¸Šé¢çš„å‡½æ•°åœ¨ç»è¿‡æ“ä½œä¹‹åï¼Œä¼šå­˜å‚¨å¯¹åº”çš„å˜é‡ï¼Œè¿™ä¸ªæ—¶å€™é‡Œé¢å­˜å‚¨çš„å˜é‡å¦‚ä¸‹ï¼š</p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312050932959.png loading=lazy></p><p>ä¸Šè¿°æ“ä½œçš„å†…å®¹éƒ½ä¼šå­˜å‚¨ä¸‹æ¥ï¼Œç„¶åå­˜å‚¨åˆ°å¯¹åº”çš„ä½ç½® ã€‚å¦‚æœè¯´ æœ‰å“ªä¸ªå˜é‡ä¸çŸ¥é“ ä»€ä¹ˆå«ä¹‰çš„ï¼Œè¯·çœ‹ä¸Šæ–‡çš„è§£é‡Šï¼Œè§£é‡Šçš„æ¯”è¾ƒæ¸…æ¥šã€‚</p><p>okï¼Œç°åœ¨æˆ‘ä»¬è®¾ç½®å®Œäº†æ‰€æœ‰å˜é‡ ï¼Œå‡ºäº†å¯¹åº”çš„ å¾ªç¯ï¼Œå³<code>block_expansion</code>å·²ç»è®¾ç½®å®Œæˆäº†ï¼Œæ¥ç€çœ‹ä¸‹é¢çš„å†…å®¹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl> <span class=bp>self</span><span class=o>.</span><span class=n>_n_pairs</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>in_type</span><span class=o>.</span><span class=n>_unique_representations</span><span class=p>)</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>out_type</span><span class=o>.</span><span class=n>_unique_representations</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è®¾ç½®<code>_n_pairs</code>ï¼Œè¿™ä¸ªçš„è¯å°±æ˜¯å°†é‡Œé¢çš„è¾“å…¥ç±»å‹çš„é•¿åº¦ä»¥åŠåˆå§‹ç±»å‹çš„é•¿åº¦è¿›è¡Œç›¸ä¹˜ï¼Œå¾—åˆ°å¯¹åº”çš„<code>_n_pairs</code>é•¿åº¦ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>_in_count</span><span class=p>,</span> <span class=n>_in_indices</span><span class=p>,</span> <span class=n>_in_contiguous</span> <span class=o>=</span> <span class=n>_retrieve_indices</span><span class=p>(</span><span class=n>in_type</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åçœ‹<code>retreve_indices</code>è¿™ä¸ªå‡½æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_retrieve_indices</span><span class=p>(</span><span class=nb>type</span><span class=p>:</span> <span class=n>FieldType</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fiber_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>_indices</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>_count</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>_contiguous</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nb>repr</span> <span class=ow>in</span> <span class=nb>type</span><span class=o>.</span><span class=n>representations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>_indices</span><span class=p>[</span><span class=nb>repr</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>+=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>fiber_position</span><span class=p>,</span> <span class=n>fiber_position</span> <span class=o>+</span> <span class=nb>repr</span><span class=o>.</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>fiber_position</span> <span class=o>+=</span> <span class=nb>repr</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>        <span class=n>_count</span><span class=p>[</span><span class=nb>repr</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>indices</span> <span class=ow>in</span> <span class=n>_indices</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># _contiguous[o_name] = indices == list(range(indices[0], indices[0]+len(indices)))</span>
</span></span><span class=line><span class=cl>        <span class=n>_contiguous</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>utils</span><span class=o>.</span><span class=n>check_consecutive_numbers</span><span class=p>(</span><span class=n>indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>_indices</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>LongTensor</span><span class=p>(</span><span class=n>indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>_count</span><span class=p>,</span> <span class=n>_indices</span><span class=p>,</span> <span class=n>_contiguous</span>
</span></span></code></pre></td></tr></table></div></div><p>çœ‹è¿™ä¸ªå‡½æ•° ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯æ ¹æ®å­—æ®µç±»å‹ï¼Œç”Ÿæˆä¸€ä¸ªå­—å…¸ <code>_indices</code>ï¼Œå…¶ä¸­åŒ…å«äº†ä¸åŒè¡¨ç¤ºï¼ˆrepresentationï¼‰çš„ç´¢å¼•åˆ—è¡¨ï¼Œå¹¶æ£€æŸ¥è¿™äº›ç´¢å¼•åˆ—è¡¨æ˜¯å¦æ˜¯è¿ç»­çš„ã€‚è¿™äº›è¡¨ç¤ºé€šå¸¸ä»£è¡¨äº†æŸç§ç±»å‹çš„å‘é‡æˆ–æ•°æ®é›†åˆåœ¨æŸä¸ªé«˜ç»´ç©ºé—´ä¸­çš„è¡¨ç¤ºã€‚</p><ol><li><p><code>fiber_position</code> è¢«åˆå§‹åŒ–ä¸º 0ï¼Œç”¨äºè¿½è¸ªç´¢å¼•çš„ä½ç½®ã€‚</p></li><li><p>åˆ›å»ºäº† <code>_indices</code> å­—å…¸ï¼Œç”¨äºå­˜å‚¨ä¸åŒè¡¨ç¤ºçš„ç´¢å¼•åˆ—è¡¨ã€‚</p></li><li><p>åˆ›å»ºäº† <code>_count</code> å­—å…¸ï¼Œç”¨äºç»Ÿè®¡æ¯ä¸ªè¡¨ç¤ºçš„å‡ºç°æ¬¡æ•°ã€‚</p></li><li><p>åˆ›å»ºäº†ä¸€ä¸ªç©ºå­—å…¸ <code>_contiguous</code>ï¼Œç”¨äºå­˜å‚¨æ¯ä¸ªè¡¨ç¤ºçš„ç´¢å¼•åˆ—è¡¨æ˜¯å¦æ˜¯è¿ç»­çš„ã€‚</p></li><li><p>å¯¹äºç»™å®šçš„ <code>type.representations</code> ä¸­çš„æ¯ä¸ªè¡¨ç¤ºï¼ˆ<code>repr</code>ï¼‰ï¼š</p><ul><li><p>å°†è¡¨ç¤ºçš„åç§°ä½œä¸ºé”®ï¼Œå°†è¯¥è¡¨ç¤ºçš„ç´¢å¼•èŒƒå›´ï¼ˆä» <code>fiber_position</code> åˆ° <code>fiber_position + repr.size</code>ï¼‰æ·»åŠ åˆ° <code>_indices</code> ä¸­ã€‚</p></li><li><p>å°† <code>fiber_position</code> æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªè¡¨ç¤ºçš„èµ·å§‹ä½ç½®ã€‚</p></li><li><p>å¢åŠ è¯¥è¡¨ç¤ºçš„è®¡æ•°å™¨ <code>_count</code>ã€‚</p></li></ul></li><li><p>å¯¹äº <code>_indices</code>ä¸­çš„æ¯ä¸ªè¡¨ç¤ºåç§°å’Œå¯¹åº”çš„ç´¢å¼•åˆ—è¡¨ï¼š</p><ul><li><p>ä½¿ç”¨ <code>utils.check_consecutive_numbers</code> å‡½æ•°æ£€æŸ¥ç´¢å¼•åˆ—è¡¨æ˜¯å¦è¿ç»­ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ <code>_contiguous</code> ä¸­ã€‚</p></li><li><p>å°†ç´¢å¼•åˆ—è¡¨è½¬æ¢ä¸º <code>torch.LongTensor</code> ç±»å‹ï¼Œå¹¶å°†å…¶é‡æ–°èµ‹å€¼ç»™ <code>_indices</code>ã€‚</p></li></ul></li><li><p>è¿”å›åŒ…å« <code>_count</code>ï¼ˆè¡¨ç¤ºè®¡æ•°ï¼‰ã€<code>_indices</code>ï¼ˆè¡¨ç¤ºçš„ç´¢å¼•åˆ—è¡¨ï¼‰å’Œ <code>_contiguous</code>ï¼ˆè¡¨ç¤ºç´¢å¼•æ˜¯å¦è¿ç»­çš„å­—å…¸ï¼‰çš„å…ƒç»„ã€‚</p></li></ol><p>åœ¨å¤„ç†å®Œäº†è¿™äº›å˜é‡ä¹‹åï¼Œå¯¹åº”å†…å®¹ å°±æ˜¯ ï¼š</p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312050954791.png loading=lazy></p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312050955920.png loading=lazy></p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312050955912.png loading=lazy></p><p>åœ¨äº†è§£ è¿™äº›å˜é‡ä¹‹åï¼Œçœ‹ä¸‹é¢ä¸€å¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl> <span class=bp>self</span><span class=o>.</span><span class=n>_out_count</span><span class=p>,</span> <span class=n>_out_indices</span><span class=p>,</span> <span class=n>_out_contiguous</span> <span class=o>=</span> <span class=n>_retrieve_indices</span><span class=p>(</span><span class=n>out_type</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸€å¥çš„ä½œç”¨å’Œä¸Šé¢ä¸€å¥çš„ä½œç”¨ç›¸åŒ ï¼Œè¿™é‡Œä¸å†è¿›è¡Œè¯¦ç»†èµ˜è¿°ã€‚</p><p>okï¼Œæ¥ç€å¾€ä¸‹çœ‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl> <span class=n>basis_ids</span> <span class=o>=</span> <span class=n>_compute_attrs_and_ids</span><span class=p>(</span><span class=n>in_type</span><span class=p>,</span> <span class=n>out_type</span><span class=p>,</span> <span class=n>_block_expansion_modules</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è®¡ç®—æ¯ä¸ªåŸºæœ¬å…ƒç´ çš„å±æ€§å’Œ idã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_compute_attrs_and_ids</span><span class=p>(</span><span class=n>in_type</span><span class=p>,</span> <span class=n>out_type</span><span class=p>,</span> <span class=n>block_submodules</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>basis_ids</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># iterate over all blocks</span>
</span></span><span class=line><span class=cl>    <span class=c1># each block is associated to an input/output representations pair</span>
</span></span><span class=line><span class=cl>    <span class=n>out_fiber_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>out_irreps_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>o</span><span class=p>,</span> <span class=n>o_repr</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>out_type</span><span class=o>.</span><span class=n>representations</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>in_fiber_position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>in_irreps_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>i_repr</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>in_type</span><span class=o>.</span><span class=n>representations</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>reprs_names</span> <span class=o>=</span> <span class=p>(</span><span class=n>i_repr</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>o_repr</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># if a basis for the space of kernels between the current pair of representations exists</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reprs_names</span> <span class=ow>in</span> <span class=n>block_submodules</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># retrieve the attributes of each basis element and build a new list of</span>
</span></span><span class=line><span class=cl>                <span class=c1># attributes adding information specific to the current block</span>
</span></span><span class=line><span class=cl>                <span class=n>ids</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>block_submodules</span><span class=p>[</span><span class=n>reprs_names</span><span class=p>]</span><span class=o>.</span><span class=n>get_basis_info</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                    <span class=c1># build the ids of the basis vectors</span>
</span></span><span class=line><span class=cl>                    <span class=c1># add names and indices of the input and output fields</span>
</span></span><span class=line><span class=cl>                    <span class=nb>id</span> <span class=o>=</span> <span class=s1>&#39;(</span><span class=si>{}</span><span class=s1>-</span><span class=si>{}</span><span class=s1>,</span><span class=si>{}</span><span class=s1>-</span><span class=si>{}</span><span class=s1>)&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i_repr</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>o_repr</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>o</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=c1># add the original id in the block submodule</span>
</span></span><span class=line><span class=cl>                    <span class=nb>id</span> <span class=o>+=</span> <span class=s2>&#34;_&#34;</span> <span class=o>+</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=n>ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># append the ids of the basis vectors</span>
</span></span><span class=line><span class=cl>                <span class=n>basis_ids</span><span class=p>[</span><span class=n>reprs_names</span><span class=p>]</span> <span class=o>+=</span> <span class=n>ids</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>in_fiber_position</span> <span class=o>+=</span> <span class=n>i_repr</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>            <span class=n>in_irreps_count</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>i_repr</span><span class=o>.</span><span class=n>irreps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>out_fiber_position</span> <span class=o>+=</span> <span class=n>o_repr</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>        <span class=n>out_irreps_count</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>o_repr</span><span class=o>.</span><span class=n>irreps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=c1># return attributes, basis_ids</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>basis_ids</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>é¦–å…ˆ åˆ›å»ºä¸€ä¸ªé»˜è®¤å€¼ä¸ºåˆ—è¡¨çš„defaultdicté˜Ÿå½¢ï¼Œç”¨äºå­˜å‚¨åŸºç¡€idsã€‚</li><li>ç„¶åè¿­ä»£è¾“å‡ºç±»å‹çš„è¡¨ç¤ºã€‚</li><li>æ¥ç€åˆå§‹åŒ–è¾“å‡ºè¡¨ç¤ºçš„èµ·å§‹ä½ç½® å’Œä¸å¯çº¦çš„è®¡æ•°ã€‚</li><li>ç„¶åè¿­ä»£è¾“å…¥ç±»å‹çš„è¡¨ç¤ºã€‚</li><li>æ¥ç€å¦‚æœå½“å‰è¡¨ç¤ºå¯¹å­˜åœ¨äº<code>block_submodules</code>ä¸­ã€‚</li><li>ç„¶åè·å–å½“å‰ç™½å“¦æ˜¯å¯¹åº”çš„æ¨¡å—çš„åŸºç¡€ä¿¡æ¯ã€‚</li><li>æ„å»ºåŸºç¡€å‘é‡çš„æ ‡è¯†ç¬¦</li><li>å°†åŸºç¡€å‘é‡çš„æ ‡è¯†ç¬¦æ·»åŠ åˆ°å¯¹åº”è¡¨ç¤ºå¯¹çš„ basis_ids åˆ—è¡¨ä¸­</li><li>æ›´æ–°è¾“å…¥è¡¨ç¤ºçš„ä½ç½®å’Œä¸å¯çº¦è¡¨ç¤ºçš„è®¡æ•°</li><li>æ›´æ–°è¾“å‡ºè¡¨ç¤ºçš„ä½ç½®å’Œä¸å¯çº¦è¡¨ç¤ºçš„è®¡æ•°</li><li>è¿”å›åŸºç¡€ ids</li></ol><p>è¿™ä¸ªå‡½æ•°çš„ä¸»è¦æµç¨‹æ˜¯å¯¹è¾“å…¥å’Œè¾“å‡ºç±»å‹çš„è¡¨ç¤ºè¿›è¡Œè¿­ä»£ï¼Œæ£€æŸ¥å¯¹åº”çš„è¡¨ç¤ºå¯¹æ˜¯å¦å­˜åœ¨äº <code>block_submodules</code> ä¸­ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™æ ¹æ®æ¨¡å—çš„åŸºç¡€ä¿¡æ¯æ„å»ºåŸºç¡€å‘é‡çš„æ ‡è¯†ç¬¦ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ <code>basis_ids</code> ä¸­ã€‚æœ€åè¿”å›è¿™äº›åŸºç¡€ idsã€‚</p><p>ç„¶åçœ‹å®Œäº†è¿™ä¸ªå‡½æ•° ï¼Œå‘ç°è¿™ä¸ª å‡½æ•°å…¶å®å¹¶ä¸æ˜¯é‡ç‚¹ï¼Œé‡Œé¢ä¸è¿‡æ˜¯å°†ä¸€äº›å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼ŒçœŸæ­£çš„é‡ç‚¹è¿˜åœ¨ä¸‹é¢ã€‚</p><p>ç„¶åæ¥ç€å¾€ä¸‹èµ°ï¼Œå‘ç°èµ°åˆ°ä¸‹é¢å‡ å¥ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>weights</span> <span class=o>=</span> <span class=n>Parameter</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>basisexpansion</span><span class=o>.</span><span class=n>dimension</span><span class=p>()),</span> <span class=n>requires_grad</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>register_buffer</span><span class=p>(</span><span class=s2>&#34;filter&#34;</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>out_type</span><span class=o>.</span><span class=n>size</span><span class=p>,</span> <span class=n>in_type</span><span class=o>.</span><span class=n>size</span><span class=p>,</span> <span class=n>kernel_size</span><span class=p>,</span> <span class=n>kernel_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>initialize</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># by default, the weights are initialized with a generalized form of He&#39;s weight initialization</span>
</span></span><span class=line><span class=cl>    <span class=n>init</span><span class=o>.</span><span class=n>generalized_he_init</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>weights</span><span class=o>.</span><span class=n>data</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>basisexpansion</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„å…¶é‚£ä¸¤å¥ç›¸å½“äºå°†é‡Œé¢çš„æ•°æ®è¿›è¡Œæ”¾å…¥ï¼Œæš‚æ—¶å…ˆä¸ç®¡å¯¹åº”çš„å†…å®¹ã€‚ç„¶åçœ‹åˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯çœ‹<code>generalized_he_init</code>è¿™ä¸ªå‡½æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>generalized_he_init</span><span class=p>(</span><span class=n>tensor</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>,</span> <span class=n>basisexpansion</span><span class=p>:</span> <span class=n>BasisExpansion</span><span class=p>,</span> <span class=n>cache</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=sa>r</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    å¯ç®—æ˜¯æ‰¾åˆ°äº†é‡ç‚¹...
</span></span></span><span class=line><span class=cl><span class=s2>    Initialize the weights of a convolutional layer with a generalized He&#39;s weight initialization method.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Because the computation of the variances can be expensive, to save time on consecutive runs of the same model,
</span></span></span><span class=line><span class=cl><span class=s2>    it is possible to cache the tensor containing the variance of each weight, for a specific ```basisexpansion```.
</span></span></span><span class=line><span class=cl><span class=s2>    This can be useful if a network contains multiple convolution layers of the same kind (same input and output types,
</span></span></span><span class=line><span class=cl><span class=s2>    same kernel size, etc.) or if one needs to train the same network from scratch multiple times (e.g. to perform
</span></span></span><span class=line><span class=cl><span class=s2>    hyper-parameter search over learning rate or to repeat an experiment with different random seeds).
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    .. note ::
</span></span></span><span class=line><span class=cl><span class=s2>        The variance tensor is cached in memory and therefore is only available to the current process.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        tensor (torch.Tensor): the tensor containing the weights
</span></span></span><span class=line><span class=cl><span class=s2>        basisexpansion (BasisExpansion): the basis expansion method
</span></span></span><span class=line><span class=cl><span class=s2>        cache (bool, optional): cache the variance tensor. By default, ```cache=False```
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Initialization</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>tensor</span><span class=o>.</span><span class=n>shape</span> <span class=o>==</span> <span class=p>(</span><span class=n>basisexpansion</span><span class=o>.</span><span class=n>dimension</span><span class=p>(),)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cache</span> <span class=ow>and</span> <span class=n>basisexpansion</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>cached_he_vars</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cached_he_vars</span><span class=p>[</span><span class=n>basisexpansion</span><span class=p>]</span> <span class=o>=</span> <span class=n>_generalized_he_init_variances</span><span class=p>(</span><span class=n>basisexpansion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>vars</span> <span class=o>=</span> <span class=n>cached_he_vars</span><span class=p>[</span><span class=n>basisexpansion</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>vars</span> <span class=o>=</span> <span class=n>_generalized_he_init_variances</span><span class=p>(</span><span class=n>basisexpansion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>tensor</span><span class=p>[:]</span> <span class=o>=</span> <span class=nb>vars</span> <span class=o>*</span> <span class=n>torch</span><span class=o>.</span><span class=n>randn_like</span><span class=p>(</span><span class=n>tensor</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ä½¿ç”¨å¹¿ä¹‰heæƒé‡åˆå§‹åŒ–å·ç§¯å±‚çš„æƒé‡ï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆå…ˆåˆ¤æ–­è¾“å…¥çš„æ•°æ®æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œå¦‚æœä¸ç¬¦åˆï¼Œåˆ™ç›´æ¥è¿›è¡Œè¿”å›ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ç¼“å­˜ï¼Œæœ‰çš„è¯ï¼Œç›´æ¥ä½¿ç”¨ä¸Šæ¬¡å·²ç»åˆå§‹åŒ–å¥½çš„å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œæ²¡æœ‰çš„è¯ï¼Œè°ƒç”¨å¯¹åº”çš„<code>_generalized_he_init_variances</code>å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_generalized_he_init_variances</span><span class=p>(</span><span class=n>basisexpansion</span><span class=p>:</span> <span class=n>BasisExpansion</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=sa>r</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    ä½¿ç”¨å¹¿ä¹‰ He æƒé‡åˆå§‹åŒ–æ–¹æ³•è®¡ç®—å·ç§¯å±‚æƒé‡çš„æ–¹å·®ã€‚
</span></span></span><span class=line><span class=cl><span class=s2>    Compute the variances of the weights of a convolutional layer with a generalized He&#39;s weight initialization method.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        basisexpansion (BasisExpansion): the basis expansion method
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>vars</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>ones</span><span class=p>((</span><span class=n>basisexpansion</span><span class=o>.</span><span class=n>dimension</span><span class=p>(),))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>inputs_count</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=nb>set</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>basis_count</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>basis_info</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>basisexpansion</span><span class=o>.</span><span class=n>get_basis_info</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>basis_info</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;in_irreps_position&#34;</span><span class=p>],</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;out_irreps_position&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>in_irrep</span><span class=p>,</span> <span class=n>out_irrep</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;in_irrep&#34;</span><span class=p>],</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;out_irrep&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>inputs_count</span><span class=p>[</span><span class=n>o</span><span class=p>]</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>in_irrep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>basis_count</span><span class=p>[(</span><span class=n>in_irrep</span><span class=p>,</span> <span class=n>o</span><span class=p>)]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>o</span> <span class=ow>in</span> <span class=n>inputs_count</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>inputs_count</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>inputs_count</span><span class=p>[</span><span class=n>o</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>w</span><span class=p>,</span> <span class=n>attr</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>basis_info</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;in_irreps_position&#34;</span><span class=p>],</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;out_irreps_position&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>in_irrep</span><span class=p>,</span> <span class=n>out_irrep</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;in_irrep&#34;</span><span class=p>],</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;out_irrep&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nb>vars</span><span class=p>[</span><span class=n>w</span><span class=p>]</span> <span class=o>=</span> <span class=mf>1.</span> <span class=o>/</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>inputs_count</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>*</span> <span class=n>basis_count</span><span class=p>[(</span><span class=n>in_irrep</span><span class=p>,</span> <span class=n>o</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>vars</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªå‡½æ•°ä½¿ç”¨å¹¿ä¹‰heæƒé‡åˆå§‹åŒ–æ–¹æ³• è®¡ç®—å·ç§¯å±‚æƒé‡çš„æ–¹å·®ï¼Œç„¶åæˆ‘ä»¬ä»ç„¶æ˜¯ä¸€è¡Œä¸€è¡Œçš„çœ‹è¿™ä¸ªä»£ç ã€‚</p><p>é¦–å…ˆçš„è¯ä»ç„¶æ˜¯æ‹¿åˆ°å¯¹åº”çš„å˜é‡ ï¼Œå°†å¯¹åº”çš„å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>è¿™é‡Œå°†æ¯ä¸ªåˆå§‹åŒ–çš„å˜é‡æˆªå›¾ï¼š</p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312051351600.png loading=lazy></p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312051351435.png loading=lazy></p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312051351232.png loading=lazy></p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312051352657.png loading=lazy></p><p>ä¸€ä¸ªå³å…´æé—®ï¼šä¸ºä»€ä¹ˆéƒ½æ˜¯960ä¸ªç»´åº¦ï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆå¾—å‡ºæ¥çš„ï¼Œè¿™é‡Œæ ‡è®°ä¸€ä¸ªTODOã€‚</p><p>ç„¶åæ¥ç€å¾€ä¸‹é¢çœ‹ï¼Œçœ‹åˆ°ç¬¬ä¸€ä¸ªå¾ªç¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl> <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>basis_info</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;in_irreps_position&#34;</span><span class=p>],</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;out_irreps_position&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>in_irrep</span><span class=p>,</span> <span class=n>out_irrep</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;in_irrep&#34;</span><span class=p>],</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;out_irrep&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs_count</span><span class=p>[</span><span class=n>o</span><span class=p>]</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>in_irrep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>basis_count</span><span class=p>[(</span><span class=n>in_irrep</span><span class=p>,</span> <span class=n>o</span><span class=p>)]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><p><code>attr</code> åœ¨æ¯æ¬¡å¾ªç¯ä¸­ä»£è¡¨ <code>basis_info</code> åˆ—è¡¨ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼ˆæˆ–è€…æ˜¯ä¸€ä¸ªå­—å…¸ï¼‰ã€‚</p><p><code>i</code> å’Œ <code>o</code> åˆ†åˆ«ç”¨äºå­˜å‚¨ <code>attr</code> å­—å…¸ä¸­çš„é”® <code>"in_irreps_position"</code> å’Œ <code>"out_irreps_position"</code> å¯¹åº”çš„å€¼ã€‚</p><p><code>in_irrep</code> å’Œ <code>out_irrep</code> å­˜å‚¨äº† <code>attr</code> å­—å…¸ä¸­é”®ä¸º <code>"in_irrep"</code> å’Œ <code>"out_irrep"</code> çš„å¯¹åº”å€¼ã€‚</p><p><code>inputs_count[o].add(in_irrep)</code>è¿™è¡Œä»£ç åœ¨åˆ›å»ºä¸€ä¸ªæ•°æ®ç»“æ„ï¼ˆå¯èƒ½æ˜¯å­—å…¸æˆ–é›†åˆï¼‰ï¼Œå…¶ä¸­ <code>o</code> æ˜¯é”®ï¼Œ<code>inputs_count[o]</code> å¯èƒ½æ˜¯ä¸€ä¸ªé›†åˆï¼Œä»£ç å°è¯•å°† <code>in_irrep</code> çš„å€¼æ·»åŠ åˆ°è¯¥é›†åˆä¸­ã€‚</p><p><code>basis_count[(in_irrep, o)] += 1</code>è¿™è¡Œä»£ç åœ¨ä¸€ä¸ªåä¸º <code>basis_count</code> çš„å­—å…¸ä¸­è®°å½•æŸäº›é”®çš„è®¡æ•°ã€‚å®ƒä½¿ç”¨äº†ä¸€ä¸ªå…ƒç»„ <code>(in_irrep, o)</code> ä½œä¸ºé”®ï¼Œå¹¶ä¸”å°†è¯¥é”®å¯¹åº”çš„å€¼ï¼ˆå‡è®¾æ˜¯ä¸€ä¸ªæ•´æ•°ï¼‰å¢åŠ äº† 1ã€‚</p><p>æŒ‰ç…§æˆ‘çš„ ç†è§£ï¼Œè¿™é‡Œé¢æ˜¯å¯¹å…¶ä¸­å˜é‡è¿›è¡Œäº†å¤åˆ¶ï¼Œç»Ÿè®¡å…¶ä¸­basisçš„ä¸ªæ•°ï¼Œå…±ä¸‹é¢ä½¿ç”¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl> <span class=k>for</span> <span class=n>o</span> <span class=ow>in</span> <span class=n>inputs_count</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs_count</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>inputs_count</span><span class=p>[</span><span class=n>o</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™å¥è¯çš„æ„æ€æ˜¯ç»Ÿè®¡å…¶ä¸­è¾“å…¥çš„ ä¸å¯çº¦è¡¨ç¤ºçš„æ€»æ•°ã€‚</p><p>ç„¶åä¸‹é¢å°±æ˜¯å¯¹åº”çš„å·ç§¯è®¡ç®—ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>w</span><span class=p>,</span> <span class=n>attr</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>basis_info</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span><span class=p>,</span> <span class=n>o</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;in_irreps_position&#34;</span><span class=p>],</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;out_irreps_position&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>in_irrep</span><span class=p>,</span> <span class=n>out_irrep</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;in_irrep&#34;</span><span class=p>],</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&#34;out_irrep&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>vars</span><span class=p>[</span><span class=n>w</span><span class=p>]</span> <span class=o>=</span> <span class=mf>1.</span> <span class=o>/</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>inputs_count</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>*</span> <span class=n>basis_count</span><span class=p>[(</span><span class=n>in_irrep</span><span class=p>,</span> <span class=n>o</span><span class=p>)])</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé¢åœ¨è¿›è¡Œå¯¹åº”ä½ç½® çš„æ–¹å·®ï¼Œä½¿ç”¨éå†çš„æ–¹å¼éå†<code>basis_info</code>ä¸­çš„æ¯ä¸ªåŸºï¼Œå¹¶ä¸”è·å–å…¶å±æ€§ä¿¡æ¯ï¼Œå¯¹äºæ¯ä¸ªåŸºï¼Œåˆ©ç”¨è¾“å…¥ä¸å¯çº¦è¡¨ç¤ºçš„ æ•°é‡å’Œè¾“å…¥åˆ°è¾“å‡ºä¸å¯çº¦è¡¨ç¤ºçš„æ•°é‡ï¼Œè®¡ç®—æƒé‡æ–¹å·®ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨<code>vars</code>ä¸­ã€‚</p><p>æ€»ä½“è€Œè¨€ï¼Œè¿™ä¸ªå‡½æ•°é€šè¿‡åŸºæ‰©å±•æ–¹æ³• <code>basisexpansion</code> æ¥è®¡ç®—å·ç§¯å±‚æƒé‡åˆå§‹åŒ–æ—¶çš„æ–¹å·®ã€‚å®ƒé¦–å…ˆç»Ÿè®¡è¾“å…¥å’ŒåŸºçš„ä¿¡æ¯ï¼Œç„¶åæ ¹æ®è¿™äº›ä¿¡æ¯è®¡ç®—æ¯ä¸ªåŸºå¯¹åº”çš„æƒé‡æ–¹å·®ï¼Œå¹¶å°†ç»“æœä½œä¸ºå¼ é‡è¿”å›ã€‚</p><p><img src=https://img-1312072469.cos.ap-nanjing.myqcloud.com/202312051406107.png loading=lazy></p><p>åœ¨è®¡ç®—å‡ºæ¥å¯¹åº”çš„æ–¹å·®ä¹‹åï¼Œå°†å…¶ä¸­çš„ å€¼è¿›è¡Œè¿”å›ï¼Œå¯¹åº”çš„å¹¿ä¹‰heå°±åˆå§‹åŒ–å®Œæˆã€‚æ•´ä¸ªå‡½æ•°å°±å®Œæˆã€‚</p><p>çœ‹åˆ°äº† è¿™é‡Œï¼Œæˆ‘æœ€å¤§çš„ç–‘é—®å‡ºæ¥äº†ï¼Œæ ¸çš„å®šä¹‰åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè®¡ç®—å‡ºå¯¹åº”çš„æ–¹å·®ï¼Œå°±ç®—æ˜¯å°†æ ¸åˆå§‹åŒ–å®Œæˆäº†ï¼Ÿ</p><p>å…³äºå·ç§¯ç¥ç»ç½‘ç»œçš„æ ¸ï¼Œè¿™é‡Œçš„è¯è¿˜æ˜¯åœ¨å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« ï¼Œæ™®åŠå…¶ä¸­çš„æ¦‚å¿µå§ã€‚</p></section><footer class=article-footer><section class=article-tags><a href=/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/>æœºå™¨å­¦ä¹ </a>
<a href=/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/>æºç é˜…è¯»</a>
<a href=/tags/%E7%BE%A4%E8%AE%BA/>ç¾¤è®º</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Apache Licence 2.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/e2cnn-%E5%86%85%E5%AE%B9%E7%90%86%E8%A7%A3-%E7%BE%A4%E7%9A%84%E8%BE%93%E5%87%BA%E7%B1%BB%E5%9E%8B/><div class=article-details><h2 class=article-title>e2cnn å†…å®¹ç†è§£ - ç¾¤çš„è¾“å‡ºç±»å‹</h2></div></a></article><article><a href=/p/e2cnn%E5%86%85%E5%AE%B9%E7%90%86%E8%A7%A3-%E7%BE%A4%E7%9A%84%E8%BE%93%E5%85%A5%E7%B1%BB%E5%9E%8B/><div class=article-details><h2 class=article-title>e2cnnå†…å®¹ç†è§£-ç¾¤çš„è¾“å…¥ç±»å‹</h2></div></a></article><article><a href=/p/e2cnn-%E5%86%85%E5%AE%B9%E7%90%86%E8%A7%A3-%E7%BE%A4%E7%9A%84%E5%88%9B%E5%BB%BA%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3/><div class=article-details><h2 class=article-title>e2cnn å†…å®¹ç†è§£ - ç¾¤çš„åˆ›å»ºæºç è¯¦è§£</h2></div></a></article><article><a href=/p/conv2d%E7%9A%84%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3/><div class=article-details><h2 class=article-title>Conv2dçš„ç®€å•ç†è§£</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({avatar:"retro",avatarcdn:"https://sdn.geekzu.org/avatar/",dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],highlight:!0,js:"https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js",lang:"zh-CN",locale:{admin:"Admin",placeholder:null},meta:["nick","mail","link"],pageSize:20,placeholder:"",requiredMeta:["name","email","url"],serverURL:"https://waline-line-git-main-zrsaber.vercel.app",uploadimage:!1,visitor:!0})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Runqi Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>